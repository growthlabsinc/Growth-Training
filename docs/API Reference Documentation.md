## API Reference Documentation (Draft 1)

This document specifies the API for the primary backend interactions related to the AI Chat Coach ("Growth Coach") feature.

**Base URL:** Not applicable directly, as interactions are via Firebase HTTPS Callable Functions. Functions are invoked by name using the Firebase SDK.
**Authentication:** All callable functions require a valid Firebase Authentication ID token, which is automatically handled by the Firebase Functions SDK when a user is signed in. Firebase App Check tokens are also automatically validated if App Check is enforced.

---

### 1. `processGrowthCoachQuery` (HTTPS Callable Function)

**Description:**
Receives a user's query from the AI Chat Coach interface, orchestrates the Retrieval-Augmented Generation (RAG) process (querying the knowledge base, calling the Gemini LLM), stores the conversation turn, and returns the AI-generated response.

**Invoked By:** iOS Application (AICoachService.swift)

**Firebase Function Name:** `processGrowthCoachQuery` (Deployed in the EU region specified in the Technology Stack, e.g., `europe-west1`)

**Method:** `POST` (Implicit via Firebase Callable Functions SDK)

**Request Payload (`data` object when calling the function):**

* **Type:** `application/json`
* **Fields:**
    * `query` (String, Required): The text message input by the user.
        * *Constraints:* Max length 1000 characters (TBD, define reasonable limit).
    * `conversationId` (String, Optional): The ID of the current ongoing conversation. If not provided or `null`, a new conversation context might be initiated by the client or inferred/generated by the backend. For MVP, the client should manage and pass this to maintain session context.
        * *Constraints:* UUID format preferred.
    * `clientContext` (Object, Optional): Any additional client-side context that might be relevant for tailoring the experience or for analytics (use with extreme caution regarding PII/sensitive data, ensure any passed data is compliant with privacy policy and data minimization).
        * Example: `{"appVersion": "1.0.2", "locale": "en_US"}`

**Request Example (Conceptual JSON sent by Firebase SDK):**
```json
{
  "query": "How can I improve my focus during Stage 1 exercises?",
  "conversationId": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "clientContext": {
    "appVersion": "1.0.0",
    "locale": "en_GB"
  }
}
```

**Success Response (`result.data` object received by the client):**

* **Type:** `application/json`
* **Status Code:** `200 OK` (Implicit for successful Callable Function execution)
* **Fields:**
    * `reply` (String): The AI-generated response text to be displayed to the user.
    * `conversationId` (String): The ID of the conversation. This will be the same as the one passed in the request, or a new one if a new conversation was initiated.
    * `timestamp` (String): ISO 8601 UTC timestamp of when the reply was generated by the server. (e.g., `"2025-05-08T18:45:00Z"`)

**Success Response Example (Conceptual JSON received by Firebase SDK):**
```json
{
  "reply": "Improving focus during Stage 1 involves consistent practice and ensuring you have a calm environment. The Growth Method guide for Stage 1 also suggests short, focused sessions initially. Would you like more details on that?",
  "conversationId": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "timestamp": "2025-05-08T18:45:00Z"
}
```

**Error Responses (Handled by Firebase Functions SDK `HttpsError`):**

The function will return an `HttpsError` in case of failure. The client should catch these errors and inspect the `code` and `message`. (Refer to `firebase_functions.https_fn.FunctionsErrorCode` for server-side Python codes and corresponding client-side error objects).

* **Common Error Codes (`FunctionsErrorCode`):**
    * `unauthenticated`: Authentication token is missing, invalid, or expired. (User needs to sign in again).
    * `invalid-argument`: The request payload is missing required fields (e.g., `query`) or fields are malformed. (Client-side validation error).
    * `unavailable`: The AI backend services (Vertex AI Search, Gemini) are temporarily unavailable or the function timed out after retries. (Client should suggest retrying later).
    * `internal`: A non-recoverable internal server error occurred during processing. (Client should suggest retrying later and the error is logged server-side for investigation).
    * `permission-denied`: (If more granular checks were added) The authenticated user does not have permission for this action.
    * `resource-exhausted`: If rate limits are hit (though 429s from underlying services should ideally be handled by retries or lead to `unavailable`).

**Error Response Example (Conceptual error object received by Firebase SDK):**
```javascript
// Client-side error object (e.g., Swift Error conforming to Firebase's error structure)
// error.code will map to one of the FunctionsErrorCode strings
// error.message will be the message string
// error.details might contain additional structured information if provided by the HttpsError
```
Example (if an `HttpsError` with code `invalid-argument` and message `"Query text cannot be empty."` was thrown):
Client receives an error where `error.code == .invalidArgument` (Swift SDK) and `error.message == "Query text cannot be empty."`.

**Security Considerations:**

* All requests are authenticated via Firebase Auth.
* App Check should be enforced to prevent abuse from non-genuine app clients.
* Input validation is performed on the `query` length and `conversationId` format.
* The Cloud Function implements logic to prevent prompt injection and ensures responses are based on curated knowledge.
* Sensitive data in logs is masked via Cloud DLP.

---
