# Story 25.2: Production Build Setup

## Story
**As a** developer  
**I want to** configure production build settings  
**So that** we can create release-ready builds for App Store submission  

## Description
Set up production build configuration in Xcode with proper code signing, Firebase production configuration, optimization settings, and ensure all debug code is stripped. This includes creating a production scheme, configuring provisioning profiles, and setting up the build pipeline for App Store distribution.

## Acceptance Criteria
- [ ] Production scheme created in Xcode
- [ ] Code signing configured with distribution certificates
- [ ] Firebase production configuration integrated
- [ ] Debug code and logging stripped
- [ ] Build optimization settings configured
- [ ] Archive builds successfully
- [ ] Export for App Store distribution works
- [ ] Build size optimized (under 100MB)

## Technical Details

### Prerequisites
- Apple Developer account with distribution certificates
- App Store Connect app record created (Story 25.1)
- Production provisioning profile
- Firebase production project configured

### Build Configuration

#### 1. Create Production Scheme
```
Scheme Name: Growth (Release)
Build Configuration: Release
Archive Configuration: Release
Analyze Configuration: Release
Test Configuration: Release
Run Configuration: Debug (for testing)
```

#### 2. Build Settings
```swift
// Release Configuration
PRODUCT_BUNDLE_IDENTIFIER = com.growthlabs.growthmethod
DEVELOPMENT_TEAM = 62T6J77P6R
CODE_SIGN_STYLE = Manual
CODE_SIGN_IDENTITY = "Apple Distribution: Growth Labs Inc (62T6J77P6R)"

// Optimization
SWIFT_OPTIMIZATION_LEVEL = -O
GCC_OPTIMIZATION_LEVEL = s
SWIFT_COMPILATION_MODE = wholemodule
ENABLE_BITCODE = NO

// Stripping
STRIP_INSTALLED_PRODUCT = YES
STRIP_SWIFT_SYMBOLS = YES
DEPLOYMENT_POSTPROCESSING = YES
SEPARATE_STRIP = YES
DEAD_CODE_STRIPPING = YES

// Debug Information
DEBUG_INFORMATION_FORMAT = dwarf-with-dsym
GCC_GENERATE_DEBUGGING_SYMBOLS = YES
SWIFT_ACTIVE_COMPILATION_CONDITIONS = RELEASE
```

#### 3. Preprocessor Macros
```swift
// Remove debug flags
SWIFT_ACTIVE_COMPILATION_CONDITIONS = RELEASE
OTHER_SWIFT_FLAGS = -DRELEASE

// Disable debug logging
#if DEBUG
    // Debug-only code
#endif
```

### Code Signing Configuration

#### 1. Provisioning Profile
```
Type: App Store Distribution
App ID: com.growthlabs.growthmethod
Certificates: Distribution Certificate
Devices: None (App Store)
```

#### 2. Entitlements
```xml
<!-- Production.entitlements -->
<dict>
    <key>com.apple.developer.applesignin</key>
    <array>
        <string>Default</string>
    </array>
    <key>com.apple.security.application-groups</key>
    <array>
        <string>group.com.growthlabs.growthmethod</string>
    </array>
    <key>aps-environment</key>
    <string>production</string>
    <key>com.apple.developer.associated-domains</key>
    <array>
        <string>applinks:growth-app.com</string>
    </array>
</dict>
```

### Firebase Production Setup

#### 1. Firebase Configuration
```swift
// Use production GoogleService-Info.plist
#if RELEASE
    FirebaseApp.configure(options: productionOptions)
#else
    FirebaseApp.configure() // Uses default plist
#endif
```

#### 2. Environment Detection
```swift
struct EnvironmentDetector {
    static var isProduction: Bool {
        #if RELEASE
            return true
        #else
            return false
        #endif
    }
    
    static var firebaseProjectId: String {
        return isProduction ? "growth-70a85" : "growth-dev-1f3f4"
    }
}
```

### Debug Code Removal

#### 1. Logging Configuration
```swift
// Logger.swift
struct Logger {
    static func log(_ message: String, level: LogLevel = .info) {
        #if DEBUG
            print("[\(level.rawValue)] \(message)")
        #endif
        // Production logging to Crashlytics only
        #if RELEASE
            if level == .error {
                Crashlytics.crashlytics().log(message)
            }
        #endif
    }
}
```

#### 2. Debug Views
```swift
// Remove debug UI
#if DEBUG
struct DebugMenuView: View {
    // Debug menu implementation
}
#endif

// In MainView
var body: some View {
    TabView {
        // Regular tabs
        #if DEBUG
        DebugMenuView()
            .tabItem { Label("Debug", systemImage: "hammer") }
        #endif
    }
}
```

### Build Optimization

#### 1. Asset Optimization
- Compress all images with ImageOptim
- Use asset catalogs for all images
- Enable app thinning
- Remove unused assets

#### 2. Code Size Optimization
```swift
// Link-time optimization
LLVM_LTO = YES

// Remove unused code
DEAD_CODE_STRIPPING = YES

// Swift specific
SWIFT_OPTIMIZATION_LEVEL = -Osize
```

#### 3. Binary Size Reduction
- Remove unused dependencies
- Use dynamic frameworks sparingly
- Enable Swift module optimization
- Strip debug symbols

### Build Script

Create `scripts/build-release.sh`:
```bash
#!/bin/bash

# Build Release Script
set -e

echo "üèóÔ∏è Building Growth App for Release..."

# Clean build folder
echo "üßπ Cleaning build folder..."
xcodebuild clean -project Growth.xcodeproj -scheme "Growth" -configuration Release

# Archive
echo "üì¶ Creating archive..."
xcodebuild archive \
    -project Growth.xcodeproj \
    -scheme "Growth" \
    -configuration Release \
    -archivePath ./build/Growth.xcarchive \
    -allowProvisioningUpdates

# Export for App Store
echo "üì§ Exporting for App Store..."
xcodebuild -exportArchive \
    -archivePath ./build/Growth.xcarchive \
    -exportPath ./build/AppStore \
    -exportOptionsPlist ./ExportOptions.plist

echo "‚úÖ Build complete!"
echo "üìç Archive: ./build/Growth.xcarchive"
echo "üìç IPA: ./build/AppStore/Growth.ipa"
```

### Export Options Plist

Create `ExportOptions.plist`:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>app-store</string>
    <key>teamID</key>
    <string>62T6J77P6R</string>
    <key>signingStyle</key>
    <string>manual</string>
    <key>signingCertificate</key>
    <string>Apple Distribution</string>
    <key>provisioningProfiles</key>
    <dict>
        <key>com.growthlabs.growthmethod</key>
        <string>Growth App Store Distribution</string>
    </dict>
    <key>uploadBitcode</key>
    <false/>
    <key>uploadSymbols</key>
    <true/>
</dict>
</plist>
```

## Implementation Steps

### Step 1: Configure Xcode Project
1. Open Growth.xcodeproj
2. Duplicate Debug configuration as Release
3. Update build settings for Release
4. Create production scheme

### Step 2: Set Up Code Signing
1. Download distribution certificate
2. Create App Store provisioning profile
3. Configure manual signing in Xcode
4. Update entitlements file

### Step 3: Firebase Configuration
1. Add production GoogleService-Info.plist
2. Update FirebaseClient for production
3. Test Firebase connection
4. Verify App Check for production

### Step 4: Clean Debug Code
1. Search for print statements
2. Wrap debug code in #if DEBUG
3. Remove development shortcuts
4. Disable verbose logging

### Step 5: Optimize Build
1. Enable compiler optimizations
2. Strip unnecessary symbols
3. Compress assets
4. Remove unused code

### Step 6: Test Build
1. Create archive
2. Validate archive
3. Export for App Store
4. Check IPA size

## Validation Checklist
- [ ] Archive builds without errors
- [ ] IPA size under 100MB
- [ ] No debug logging in release build
- [ ] Firebase connects to production
- [ ] Code signing validates
- [ ] No development URLs/keys
- [ ] Optimizations applied
- [ ] dSYM files generated

## Dependencies
- Completed App Store Connect setup (Story 25.1)
- Distribution certificate in keychain
- Production Firebase project ready
- Production GoogleService-Info.plist

## Security Considerations
- Ensure no API keys in code
- Remove all debug endpoints
- Disable development shortcuts
- Verify certificate pinning
- Check for exposed secrets

## Notes
- Always test release builds thoroughly
- Keep debug and release configs separate
- Document any production-specific settings
- Maintain separate Firebase projects
- Use TestFlight for final validation

## Definition of Done
- Production scheme configured
- Code signing working
- Firebase production integrated
- Debug code removed
- Build optimized
- Archive validates for App Store
- Documentation updated
- Build script created