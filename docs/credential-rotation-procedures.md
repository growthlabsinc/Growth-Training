# App Store Connect API Credential Rotation Procedures

## Overview

This document outlines the procedures for rotating App Store Connect API credentials with zero downtime. Credential rotation should be performed quarterly or immediately if a security incident occurs.

## Rotation Schedule

| Quarter | Rotation Window | Responsible | Reviewer |
|---------|----------------|-------------|----------|
| Q1 | March 15-20 | Platform Lead | CTO |
| Q2 | June 15-20 | Platform Lead | CTO |
| Q3 | September 15-20 | Platform Lead | CTO |
| Q4 | December 15-20 | Platform Lead | CTO |

## Pre-Rotation Checklist

- [ ] Schedule maintenance window (optional but recommended)
- [ ] Notify stakeholders 48 hours in advance
- [ ] Backup current configuration
- [ ] Verify rollback procedures
- [ ] Ensure two authorized personnel available
- [ ] Test in staging environment first

## Zero-Downtime Rotation Procedure

### Phase 1: Preparation (15 minutes)

1. **Backup Current Configuration**
   ```bash
   # Save current config
   firebase functions:config:get > config-backup-$(date +%Y%m%d).json
   
   # Backup private key
   cp functions/keys/AuthKey_*.p8 functions/keys/backup/
   ```

2. **Verify Current State**
   ```bash
   # Test current credentials
   cd functions
   node scripts/validate-credentials.js
   
   # Note the output - should show all green checks
   ```

3. **Monitor Current Metrics**
   - Open subscription dashboard
   - Note current success rate
   - Watch for any anomalies

### Phase 2: Generate New Credentials (10 minutes)

1. **Log into App Store Connect**
   - URL: https://appstoreconnect.apple.com
   - Navigate to: Users and Access > Keys

2. **Generate New API Key**
   - Click "Generate API Key" or "+"
   - Name: `Growth-API-Key-YYYY-MM-DD`
   - Access: In-App Purchase (minimum required)
   - Download the .p8 file immediately (one-time download!)

3. **Document New Credentials**
   ```
   New Key ID: ________________
   Issuer ID: ________________ (unchanged)
   File Name: AuthKey_______________.p8
   Generated: ________________
   Generated By: ________________
   ```

### Phase 3: Dual-Key Deployment (20 minutes)

This phase allows both old and new keys to work simultaneously.

1. **Deploy Dual-Key Function**
   ```javascript
   // Temporarily modify validateSubscriptionReceipt to accept both keys
   // This is already prepared in functions/src/dualKeyValidation.js
   ```

2. **Add New Key to Firebase**
   ```bash
   # Upload new key
   cp ~/Downloads/AuthKey_NEW_KEY_ID.p8 functions/keys/
   
   # Set secondary key config
   firebase functions:config:set \
     appstore.new_key_id="NEW_KEY_ID" \
     appstore.rotation_mode="true"
   ```

3. **Deploy with Dual-Key Support**
   ```bash
   # Deploy the dual-key validation function
   firebase deploy --only functions:validateSubscriptionReceiptDualKey
   ```

4. **Verify Both Keys Work**
   ```bash
   # Test with monitoring script
   node scripts/test-dual-keys.js
   ```

### Phase 4: Transition to New Key (15 minutes)

1. **Update Primary Configuration**
   ```bash
   # Switch to new key as primary
   firebase functions:config:set \
     appstore.key_id="NEW_KEY_ID" \
     appstore.old_key_id="OLD_KEY_ID"
   
   # Deploy configuration
   firebase deploy --only functions
   ```

2. **Monitor Transition**
   - Watch success rate on dashboard
   - Check for any validation errors
   - Monitor for 5 minutes

3. **Verify New Key**
   ```bash
   # Run validation with new key
   cd functions
   node scripts/validate-credentials.js
   ```

### Phase 5: Cleanup (10 minutes)

1. **Remove Old Key Support**
   ```bash
   # After 24 hours of stable operation
   firebase functions:config:unset appstore.old_key_id
   firebase functions:config:unset appstore.rotation_mode
   
   # Deploy final configuration
   firebase deploy --only functions
   ```

2. **Revoke Old Key**
   - Return to App Store Connect
   - Find old key in list
   - Click "Revoke"
   - Confirm revocation

3. **Secure Cleanup**
   ```bash
   # Archive old key (don't delete immediately)
   mv functions/keys/AuthKey_OLD_KEY_ID.p8 functions/keys/archive/
   
   # Update documentation
   echo "Rotated on $(date)" >> functions/keys/rotation-log.txt
   ```

## Emergency Rotation Procedure

Use this procedure if credentials are compromised.

### Immediate Actions (5 minutes)

1. **Revoke Compromised Key**
   - App Store Connect > Keys > Revoke immediately
   - Do NOT wait for new key generation

2. **Enable Emergency Mode**
   ```bash
   # Disable server validation temporarily
   firebase functions:config:set \
     appstore.emergency_mode="true" \
     appstore.emergency_reason="Key rotation in progress"
   
   firebase deploy --only functions
   ```

3. **Alert Stakeholders**
   ```
   Subject: URGENT: Subscription Key Rotation In Progress
   
   We are performing an emergency credential rotation.
   Impact: New subscriptions may experience delays
   ETA: 30 minutes
   Status: https://status.growth.app
   ```

### Fast Rotation (10 minutes)

1. **Generate New Key** (as in Phase 2 above)

2. **Direct Deployment**
   ```bash
   # Skip dual-key phase in emergency
   firebase functions:config:set \
     appstore.key_id="NEW_KEY_ID" \
     appstore.emergency_mode="false"
   
   # Add new key file
   cp ~/Downloads/AuthKey_NEW_KEY_ID.p8 functions/keys/
   
   # Deploy immediately
   firebase deploy --only functions --force
   ```

3. **Verify Operations**
   ```bash
   node scripts/validate-credentials.js
   ```

## Rollback Procedures

If issues occur during rotation:

### Rollback Steps

1. **Restore Previous Configuration**
   ```bash
   # Restore from backup
   firebase functions:config:set appstore="$(cat config-backup-YYYYMMDD.json | jq .appstore)"
   
   # Deploy rollback
   firebase deploy --only functions
   ```

2. **Restore Old Key**
   ```bash
   # Copy key back
   cp functions/keys/backup/AuthKey_OLD_KEY_ID.p8 functions/keys/
   ```

3. **Verify Rollback**
   ```bash
   node scripts/validate-credentials.js
   ```

## Post-Rotation Tasks

### Immediate (Day 0)
- [ ] Update password manager with new credentials
- [ ] Update runbook documentation
- [ ] Notify team of completion
- [ ] Monitor metrics for 24 hours

### Day 1
- [ ] Remove old key from App Store Connect
- [ ] Archive old key file securely
- [ ] Update disaster recovery documentation
- [ ] Schedule next rotation

### Week 1
- [ ] Review rotation process
- [ ] Update procedures based on lessons learned
- [ ] Train backup personnel on new procedures

## Monitoring During Rotation

### Key Metrics to Watch
- Receipt validation success rate (target: >99%)
- Validation latency (target: <2s)
- Error rate by type
- New subscription activation rate

### Alert Thresholds
- Success rate drops below 95%
- Latency exceeds 5 seconds
- Any authentication errors (401)
- Circuit breaker activation

### Dashboard URLs
- [Real-time Metrics](https://growth.app/admin/metrics)
- [Firebase Console](https://console.firebase.google.com/project/growth-70a85)
- [Error Logs](https://console.firebase.google.com/project/growth-70a85/functions/logs)

## Security Considerations

### Key Storage
- Never commit keys to source control
- Use encrypted storage for backups
- Limit access to key files
- Audit key access regularly

### Access Control
- Require MFA for App Store Connect
- Use separate accounts for generation
- Document who has access
- Review access quarterly

### Audit Trail
- Log all rotation activities
- Screenshot key generation
- Document approval chain
- Store in secure location

## Troubleshooting

### Common Issues

**Issue: New key not recognized**
- Verify key ID matches exactly
- Check file permissions (600)
- Ensure .p8 extension preserved

**Issue: Validation failures after rotation**
- Check both keys during transition
- Verify environment variables
- Monitor specific error codes

**Issue: Cannot generate new key**
- Verify account permissions
- Check key limit (max 50)
- Contact Apple support if needed

## Communication Templates

### Planned Rotation Notice
```
Subject: Scheduled Subscription Credential Rotation - [DATE]

Team,

We will be performing routine credential rotation on [DATE] at [TIME].

Impact: Minimal - designed for zero downtime
Duration: 1 hour
Action Required: None

Monitor: https://status.growth.app

- Platform Team
```

### Rotation Complete Notice
```
Subject: Subscription Credential Rotation Complete

Team,

Credential rotation completed successfully at [TIME].

Results:
- New credentials active ✓
- Zero downtime achieved ✓
- All systems operational ✓

Next rotation: [DATE]

- Platform Team
```

## Appendix

### Script: test-dual-keys.js
```javascript
// Located at: functions/scripts/test-dual-keys.js
// Tests both old and new keys during rotation
```

### Script: monitor-rotation.sh
```bash
#!/bin/bash
# Located at: functions/scripts/monitor-rotation.sh
# Real-time monitoring during rotation
```

### Emergency Contacts
- Platform Lead: [Name] - [Phone]
- CTO: [Name] - [Phone]
- Apple Developer Support: 1-800-633-2152

---

**Document Version:** 1.0
**Last Updated:** January 2025
**Next Review:** April 2025
**Owner:** Platform Team