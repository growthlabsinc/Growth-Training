# Story 7.4: Post-Timer Flow: Tagging Time Log with Session Notes

**Status:** Review

## Goal & Context

**User Story:** As a User, after completing an exercise with the timer, I want to easily log this session with the duration pre-filled and add notes.

**Context:** This story builds upon the previously implemented timer functionality (Stories 7.1-7.3) and connects it to the session logging functionality implemented in Epic 4. When a user completes a timed exercise, they should be prompted to log the session, with relevant information like the method and duration pre-filled, allowing for quick and easy record-keeping.

## Detailed Requirements

- When the timer is stopped/finished (or a countdown completes):
  - Prompt the user: "Log this session?"
  - If "Yes": Navigate to the "Log Session" screen (from Epic 4).
  - Pre-fill the "Date/Time" (current), "Method" (the one timer was for), and "Duration" (from the timer) fields.
  - User can then add notes and save the log.
- If "No": Discard timer data and navigate back to the Method Detail or Methods screen.

## Acceptance Criteria (ACs)

- AC1: User is prompted to log session after timer completion.
- AC2: If user chooses to log, Log Session screen is presented with Method and Duration pre-filled.
- AC3: User can successfully add notes and save the pre-filled log.
- AC4: If user chooses not to log, no session is saved.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards and understand the project structure. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Modify:
    - `Growth/Features/Timer/ViewModels/TimerViewModel.swift` (Update to handle session logging navigation)
    - `Growth/Features/Timer/Views/TimerView.swift` (Update UI for completion actions)

  - Files to Reference:
    - `Growth/Core/Models/SessionLog.swift` (Session log data model)
    - `Growth/Features/SessionLogging/ViewModels/LogSessionViewModel.swift`
    - `Growth/Features/SessionLogging/Views/LogSessionView.swift`
    - `Growth/Core/Services/FirestoreService.swift` (For session logging operations)

- **Key Technologies:**
  - SwiftUI for UI updates
  - Combine for state management
  - Sheet presentation for LogSessionView

- **Integration Details:**
  - `TimerViewModel` already has a `showCompletionActions` property which is displayed when a timer completes
  - `LogSessionView` has a constructor that accepts a `GrowthMethod` parameter to pre-fill the method
  - `LogSessionViewModel` handles all the business logic for creating and saving session logs
  - The timer total elapsed time (for stopwatch) or total duration (for countdown/interval) should be used to pre-fill the duration

- **UI/UX Notes:** 
  - The completion actions UI is already partially implemented in `TimerView.swift`
  - The "Log Session" button should be the primary action
  - The "Dismiss" button should be the secondary action
  - Transitions should be smooth and intuitive

- **Data Structures:**
  - `SessionLog` model in `SessionLog.swift` (requires userId, methodId, startTime, duration, notes, moodBefore, moodAfter)
  - `GrowthMethod` model for passing the method information to LogSessionView
  - The current method can be accessed via `timerService.activeTimerConfig` in the TimerViewModel

## Tasks / Subtasks

- [x] Update `TimerViewModel.swift` to support session logging
  - [x] Add property for tracking if we should present the LogSessionView
  - [x] Add method to prepare session logging with current timer data
  - [x] Calculate the correct duration from timer data (total elapsed time for stopwatch, configured duration for countdown/interval)

- [x] Update `TimerView.swift` completion actions
  - [x] Modify the "Log Session" button to call new method in TimerViewModel 
  - [x] Add a sheet presentation for LogSessionView when user chooses to log
  - [x] Pass the correct GrowthMethod and duration to LogSessionView

- [x] Test with various timer modes
  - [x] Test with stopwatch mode
  - [x] Test with countdown mode
  - [x] Test with interval mode
  - [x] Verify that the correct duration is calculated and passed in each case

- [x] Handle edge cases
  - [x] What happens if there is no associated method (e.g., using stopwatch mode without a method)?
  - [x] What happens if the session is very short (< 1 minute)?
  - [x] What happens if the user dismisses LogSessionView without saving?

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

- **Unit Tests:** 
  - Test that the timer correctly calculates and formats duration for logging
  - Test that the necessary data is prepared correctly for LogSessionView

- **Manual Verification:** 
  - Verify complete timer flow (start, run, complete) -> log session flow with all three timer modes (stopwatch, countdown, interval)
  - Verify that canceling from the "Log Session?" prompt returns to the appropriate screen
  - Verify that canceling from the LogSessionView returns to the timer screen
  - Verify that all pre-filled data is accurate (method, duration, date/time)
  - Verify that saving the log from this flow works correctly
  - Verify that using "Dismiss" button correctly discards the timer session 