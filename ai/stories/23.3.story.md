# Story 23.3: Create Subscription State Management Service

## Meta Information
- **Story ID**: 23.3
- **Epic**: 23 - Subscription Monetization Infrastructure  
- **Status**: Draft
- **Priority**: Medium
- **Story Points**: 5
- **Assignee**: Dev Agent
- **Dependencies**: Story 23.0 (Firebase Functions), Story 23.2 (StoreKit Integration)
- **Created**: 2025-07-05
- **Updated**: 2025-07-05

## User Story
As a Growth app user, I want my subscription status to be consistently maintained across app sessions and device states, so that I can reliably access my subscribed features without interruption or confusion.

## Background
With StoreKit 2 integration (Story 23.2) providing purchase capabilities and existing SubscriptionEntitlementService handling feature access, we need a dedicated state management service to coordinate subscription state across the entire app lifecycle. This service will bridge StoreKit transaction monitoring with our existing entitlement system.

## Acceptance Criteria

### Core Functionality
- [ ] Create SubscriptionStateManager service that monitors StoreKit transaction updates
- [ ] Implement automatic subscription state synchronization on app launch
- [ ] Provide real-time subscription status updates to UI components
- [ ] Handle subscription expiration and renewal notifications
- [ ] Manage subscription state persistence across app sessions

### State Management
- [ ] Integrate with existing SubscriptionEntitlementService for feature access validation
- [ ] Coordinate with StoreKitService for transaction monitoring  
- [ ] Publish subscription state changes via Combine publishers
- [ ] Cache subscription state locally with proper invalidation
- [ ] Handle offline scenarios gracefully

### Error Handling
- [ ] Provide fallback mechanisms when StoreKit is unavailable
- [ ] Handle network connectivity issues during state synchronization
- [ ] Retry failed subscription validations with exponential backoff
- [ ] Log state management errors for debugging

### Integration Points
- [ ] Connect to existing SubscriptionEntitlementService without breaking changes
- [ ] Work with StoreKitService transaction monitoring
- [ ] Support paywalls and subscription UI components
- [ ] Integrate with app lifecycle events (foreground/background)

## Technical Implementation

### Service Architecture
```swift
class SubscriptionStateManager: ObservableObject {
    @Published var subscriptionState: SubscriptionState
    @Published var isLoading: Bool
    @Published var lastError: Error?
    
    private let storeKitService: StoreKitService
    private let entitlementService: SubscriptionEntitlementService
    private var transactionUpdateTask: Task<Void, Never>?
}
```

### State Model
```swift
struct SubscriptionState {
    let tier: SubscriptionTier
    let status: SubscriptionStatus  // active, expired, trial, cancelled
    let expirationDate: Date?
    let isTrialActive: Bool
    let autoRenewalEnabled: Bool
    let lastUpdated: Date
}
```

### Integration Points
- Consume StoreKit transaction updates from StoreKitService
- Update SubscriptionEntitlementService when state changes
- Provide state to subscription UI components
- Coordinate with Firebase Functions for server-side validation

## Testing Requirements

### Unit Tests
- [ ] Test state synchronization logic
- [ ] Test transaction update handling
- [ ] Test offline state management
- [ ] Test error scenarios and recovery
- [ ] Test integration with existing services

### Integration Tests  
- [ ] Test StoreKit transaction monitoring integration
- [ ] Test SubscriptionEntitlementService coordination
- [ ] Test app lifecycle state management
- [ ] Test subscription renewal scenarios

### Manual Testing
- [ ] Verify subscription state consistency across app restarts
- [ ] Test subscription renewal and expiration flows
- [ ] Verify offline behavior and state recovery
- [ ] Test subscription cancellation handling

## Dev Notes

### Dependencies
- Requires StoreKitService from Story 23.2
- Integrates with existing SubscriptionEntitlementService
- Uses Combine framework for reactive state updates
- Requires iOS 15.0+ for StoreKit 2 transaction monitoring

### Integration Strategy
The SubscriptionStateManager will act as a coordinator between:
1. StoreKitService - for transaction monitoring and validation
2. SubscriptionEntitlementService - for feature access control
3. UI Components - for real-time state updates
4. App Lifecycle - for background/foreground state management

### Technical Considerations
- Use Task-based async monitoring for StoreKit transactions
- Implement proper cancellation of monitoring tasks on deinit
- Cache state in UserDefaults with timestamp-based invalidation
- Use weak references to prevent retain cycles in Combine subscriptions
- Handle iOS version compatibility with #available checks

### Files to Create/Modify
- Growth/Core/Services/SubscriptionStateManager.swift (new)
- Growth/Core/Models/SubscriptionState.swift (new)
- Growth/Features/Settings/SettingsView.swift (integrate state manager)
- GrowthTrainingApp.swift (initialize state manager)

## Success Metrics
- Subscription state consistency maintained across 99%+ of app sessions
- Transaction state updates processed within 2 seconds
- Zero subscription-related feature access inconsistencies
- Proper handling of all subscription lifecycle events

## Dev Agent Record

### Status: Draft

### Tasks Completed
- [x] Analyzed Epic 23 requirements for Story 23.3
- [x] Reviewed existing SubscriptionEntitlementService architecture
- [x] Examined StoreKit 2 integration from Story 23.2  
- [x] Designed SubscriptionStateManager service architecture
- [x] Created comprehensive story documentation
- [x] Defined integration points with existing services
- [x] Specified testing requirements and success metrics

### Next Steps
1. Implement SubscriptionStateManager service class
2. Create SubscriptionState model with all required properties
3. Integrate StoreKit transaction monitoring using Task-based async patterns
4. Connect with SubscriptionEntitlementService for state coordination
5. Add state persistence and caching mechanisms
6. Implement app lifecycle integration for background/foreground handling
7. Add comprehensive error handling and retry logic
8. Write unit tests for all state management scenarios
9. Perform integration testing with existing subscription components

### Notes
This story builds on the StoreKit 2 foundation from Story 23.2 while working with the existing SubscriptionEntitlementService. The state manager serves as a coordination layer that ensures subscription state consistency across the entire app lifecycle. Implementation should prioritize compatibility with existing code while providing the reactive state updates needed for modern SwiftUI interfaces.

### Implementation Estimate
- Service creation: 2 story points
- State model and integration: 2 story points  
- Testing and validation: 1 story point
- **Total: 5 story points**