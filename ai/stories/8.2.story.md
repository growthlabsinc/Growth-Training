# Story 8.2: Scheduled Push Notifications for Streaks & Achievements

**Status:** Ready

## Goal & Context

**User Story:** As a User, I want to receive timely push notifications about my practice streak maintenance and achievements, so I stay engaged with the app and feel motivated to maintain my progress.

**Context:** This story builds upon the push notification setup (Story 8.1) which configured basic notification permission handling, device token registration, and notification preferences. Now we'll implement the specific notification scheduling system focusing on streak maintenance and achievements, which are core elements of the app's gamification system. This will help users stay engaged and reminded to practice regularly.

## Detailed Requirements

- Define an initial set of 3-5 MVP badges in Firestore (`badges` collection: badgeId, name, description, criteria (e.g., `sessionsLogged: 10`, `stageCompleted: "Beginner"`), icon_placeholder_url).
- Examples:
  - "First Session Logged"
  - "7 Day Streak"
  - "Beginner Stage Mastered" (requires integration with progression logic - Story 9.X)
  - "25 Sessions Logged"
- When user actions meet badge criteria, award the badge to the user (e.g., store awarded badge IDs in their user profile).
- Display a simple, non-intrusive notification/animation when a new badge is earned.

## Acceptance Criteria (ACs)

- AC1: Badge definitions are stored in Firestore.
- AC2: Logic correctly awards badges to users when criteria are met.
- AC3: Users receive a notification (e.g., a small banner or alert) upon earning a new badge.
- AC4: Awarded badges are recorded for the user.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files/Components to Create:**
  - `Growth/Core/Models/Badge.swift` - Model for badge definitions
  - `Growth/Features/Notifications/StreakTracker.swift` - Service to track and manage user streaks 
  - `Growth/Features/Stats/Views/StreakStatsView.swift` - UI component to display streak information
  - `Growth/Features/Stats/ViewModels/StreakStatsViewModel.swift` - ViewModel for streak statistics

- **Relevant Files to Modify:**
  - `Growth/Core/Services/FirestoreService.swift` - Add methods for badge storage and retrieval
  - `Growth/Features/Notifications/NotificationSchedulerService.swift` - Add streak notification scheduling
  - `Growth/Features/Notifications/NotificationsManager.swift` - Add achievement notification handling
  - `Growth/Application/AppDelegate.swift` - Initialize StreakTracker on app launch
  - `Growth/Features/Dashboard/Views/DashboardView.swift` - Add streak statistics display

- **Key Technologies:**
  - Firestore for storing badge definitions and user achievements
  - UserNotifications framework for scheduled local notifications
  - SwiftUI for streak statistics display
  - Combine for reactive state updates

- **API Interactions / SDK Usage:**
  - Firestore to store and retrieve badge definitions and user progress
  - UserNotifications for scheduling and managing notifications
  - FirebaseAuth for identifying current user

- **UI/UX Notes:**
  - Streak statistics should be prominently displayed with a flame icon using a color that reflects streak length
  - Achievement notifications should be non-intrusive but visually appealing
  - Consider adding a quick practice option on the streak view to help users maintain their streak

- **Data Structures:**
  - Badge model: `id`, `name`, `description`, `criteria`, `iconURL`
  - StreakData: `currentStreak`, `longestStreak`, `lastPracticeDate`
  - SessionLog extended to track practice sessions for streak calculations

- **Environment Variables:**
  - No new environment variables needed for this story

- **Coding Standards Notes:**
  - Follow Apple's guidelines for local notifications
  - Ensure notifications are respectful of user preferences
  - Use proper error handling for asynchronous operations

## Tasks / Subtasks

- [ ] Create Badge model
  - [ ] Define badge properties (id, name, description, criteria, icon URL)
  - [ ] Add Firestore serialization/deserialization

- [ ] Implement StreakTracker service
  - [ ] Create streak tracking logic (consecutive days calculation)
  - [ ] Implement methods to check if streak is at risk
  - [ ] Add streak milestone detection for achievements

- [ ] Create notification scheduling service for streaks and achievements
  - [ ] Schedule daily practice reminders
  - [ ] Schedule streak maintenance alerts when streak is at risk
  - [ ] Create achievement notifications

- [ ] Implement badge criteria validation
  - [ ] Setup listeners for relevant user actions
  - [ ] Check badge criteria against user activity
  - [ ] Award badges when criteria are met

- [ ] Design and implement StreakStatsView
  - [ ] Display current streak, longest streak, and last practice date
  - [ ] Add quick practice button to help maintain streak
  - [ ] Implement streak-at-risk warning

- [ ] Update Dashboard with streak information
  - [ ] Add streak counter to dashboard
  - [ ] Provide link to full streak statistics

- [ ] Set up notification actions for streak and achievement notifications
  - [ ] "Practice Now" action for streak reminders
  - [ ] "View Details" action for achievement notifications

- [ ] Test notification delivery in various app states
  - [ ] Foreground notifications
  - [ ] Background notifications
  - [ ] Notification actions and deep linking

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:**
  - Test streak calculation logic for various scenarios (consecutive days, broken streak, etc.)
  - Test badge criteria validation logic
  - Test notification scheduling and cancellation

- **Integration Tests:**
  - Verify that streak counters update correctly when sessions are logged
  - Confirm that badges are awarded when criteria are met
  - Check that notifications are scheduled and delivered appropriately

- **Manual Verification:**
  - Test streak tracking over multiple days
  - Verify notifications arrive at the expected times
  - Confirm that achievements are properly displayed and stored
  - Check that notification actions navigate to the correct screens 