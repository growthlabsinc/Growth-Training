# Story 19.6: Implement Onboarding Flow Orchestration & Interactive Elements

**Status:** Review

## Goal & Context

**User Story:** As a New User, I want a smooth, guided onboarding flow with clear progress indication and satisfying interactive elements, making the initial setup feel effortless and engaging.

**Context:** This story finalizes the onboarding experience by implementing flow orchestration, ensuring all screens (19.1 to 19.5) are presented in the correct sequence. It adds interactive polish through progress indicators, button feedback, and selection animations. This creates a cohesive, professional onboarding experience that sets the tone for the entire app. The foundational components and screens already exist, so this story focuses on refinements and orchestration.

## Detailed Requirements

- **Flow Orchestration:** Ensure the screens (19.1 to 19.5) are presented in the correct sequence as per the User Flow Diagram.
- **Progress Indicator:** Implement a subtle, segmented progress bar at the top or bottom of each onboarding screen. Segments fill with an animation (e.g., emerald-to-teal gradient) upon step completion.
- **Button Feedback:** Primary action buttons ("Get Started," "Continue") provide haptic feedback and a gentle scaling animation on tap.
- **Selection Animation:** Checkboxes and key selection elements (e.g., assessment choice) use subtle animations to confirm selection.
- **Skip Logic:** If user skips routine selection (Story 19.4), ensure they are smoothly transitioned to Notification Permissions and then the main app (defaulting to ad-hoc practice).

## Acceptance Criteria (ACs)

- AC1: The onboarding screens appear in the defined logical order.
- AC2: A visual progress indicator accurately reflects the user's stage in the onboarding flow.
- AC3: Primary buttons and selection elements provide the specified haptic and visual feedback.
- AC4: Skip logic is handled correctly, leading to a coherent user experience.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards and understand the project structure. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Create: 
    - `Growth/Core/UI/Components/ProgressIndicator.swift` (reusable animated progress bar component)
    - `Growth/Core/UI/Components/Buttons/AnimatedPrimaryButton.swift` (primary button with feedback)
  - Files to Modify: 
    - `Growth/Features/Onboarding/Views/OnboardingFlowCoordinator.swift` (enhance ProgressBar with animation)
    - `Growth/Features/Onboarding/Views/DisclaimerView.swift` (add button feedback)
    - `Growth/Features/Onboarding/Views/PrivacyTermsConsentView.swift` (add checkbox animations)
    - `Growth/Features/Onboarding/Views/InitialAssessmentView.swift` (add selection animations)
    - `Growth/Features/Onboarding/Views/RoutineGoalSelectionView.swift` (verify skip logic)
    - Existing Welcome, Profile setup views to integrate proper button feedback

- **Key Technologies:**

  - SwiftUI animations and transitions
  - UIKit haptic feedback (UIImpactFeedbackGenerator)
  - SwiftUI @State and withAnimation for interactive elements
  - GeometryReader for progress bar layout
  - SwiftUI gradient fills for progress animation

- **API Interactions / SDK Usage:**

  - ThemeManager.shared.hapticFeedback - existing property to check if haptics are enabled
  - UIImpactFeedbackGenerator for haptic feedback (light, medium, heavy styles)
  - SwiftUI animation modifiers (.animation, withAnimation, .transition)

- **UI/UX Notes:**

  - Progress bar styling:
    - Height: 8dp (already implemented)
    - Background: Pale Green (#E6F4F0)
    - Fill: Core Green (#0A5042) with animated gradient to Bright Teal (#00BFA5)
    - Corner radius: 4dp
    - Smooth spring animation when advancing
  - Button feedback:
    - Scale effect: 0.95 when pressed
    - Animation duration: 0.1s ease-in-out
    - Haptic: medium impact for primary actions, light for secondary
  - Checkbox animations:
    - Spring animation with 0.3s response
    - Check mark should animate in with scale effect
  - Flow transitions:
    - Use .slide transition between steps
    - Animation should be smooth (.easeInOut)

- **Data Structures:**

  - No new data structures needed - animations are UI-only enhancements

- **Environment Variables:**

  - None specific to this story

- **Coding Standards Notes:**
  - Follow SwiftUI animation best practices
  - Ensure animations respect user's reduced motion settings
  - Keep animation durations consistent (0.1s for button feedback, 0.3s for larger transitions)
  - Use @ObservedObject for ThemeManager to respect haptic preferences
  - Leverage existing button styles (ScaleButtonStyle) where appropriate

## Tasks / Subtasks

- [x] Enhance ProgressBar component with gradient animation
  - [x] Add gradient fill from Core Green to Bright Teal
  - [x] Implement spring animation when progress changes
  - [x] Ensure smooth transitions between steps
- [x] Create AnimatedPrimaryButton component
  - [x] Implement scale effect on press (0.95)
  - [x] Add haptic feedback (medium impact)
  - [x] Ensure consistent animation timing (0.1s)
- [x] Update existing onboarding screens with button feedback
  - [x] DisclaimerView: Add feedback to "Continue" button
  - [x] PrivacyTermsConsentView: Add feedback to "Continue" button
  - [x] InitialAssessmentView: Add feedback to choice buttons
  - [x] WelcomeView: Implement proper welcome screen with feedback
- [x] Add checkbox animations
  - [x] PrivacyTermsConsentView: Animate checkbox selection
  - [x] DisclaimerView: Animate checkbox selection if present
- [x] Verify and enhance flow orchestration
  - [x] Ensure proper step transitions with slide animation
  - [x] Test skip logic from routine selection
  - [x] Verify progress bar updates correctly at each step
- [x] Add reduced motion support
  - [x] Check UIAccessibility.isReduceMotionEnabled
  - [x] Provide fallback for users with motion sensitivity

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

- **Unit Tests:** 
  - Test that progress calculation in ProgressBar is correct for each step
  - Verify that skip logic properly advances through remaining steps
  - Test that haptic feedback respects ThemeManager settings

- **Integration Tests:**
  - Test complete onboarding flow from welcome to completion
  - Verify animations trigger at appropriate times
  - Test that skipping routine selection leads to notification permissions

- **Manual/UI Verification:**
  - Verify progress bar animates smoothly between steps
  - Test haptic feedback on physical device
  - Verify button scale animations are subtle and professional
  - Test checkbox animations are satisfying but not distracting
  - Verify all animations respect reduced motion settings
  - Test complete flow including skip scenarios
  - Ensure no animation glitches during rapid navigation

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** Claude Opus 4 (claude-opus-4-20250514)
- **Completion Notes:** 
  - Successfully implemented all interactive elements and flow orchestration
  - Created reusable ProgressIndicator component with gradient animations and reduced motion support
  - Created AnimatedPrimaryButton component with haptic feedback and scale animations
  - Enhanced all onboarding screens with appropriate animations and feedback
  - Added checkbox animations with spring effects in consent screens
  - Updated flow transitions to use asymmetric slide animations for better UX
  - Verified skip logic in RoutineGoalSelectionView properly advances the flow
  - All animations respect user's reduced motion settings
  - Existing ScaleButtonStyle was leveraged where appropriate
  - ProfileSetupView was enhanced from placeholder to full implementation
- **Change Log:** 
  - Initial implementation completed