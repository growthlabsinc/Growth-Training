# Story 15.4: Implement New Navigation Transitions & Context Preservation

**Status:** Review

## Goal & Context

**User Story:** As a User, I want navigation to feel smart and context-aware, helping me understand where I am in a complex flow, like a multi-method routine day.

**Context:** This story builds upon the unified practice entry points and routine selection flow (Story 15.3) by implementing smart navigation transitions and context preservation. The app already has multi-method practice sessions through DailyRoutineView and TimerView, but needs enhanced navigation awareness and smarter return flows. This story focuses on making navigation feel intelligent and maintaining user context throughout complex practice flows.

## Detailed Requirements

- Implement new transition strategies:
  - **Continuous Flow:** Design for seamless progression through multi-method days (technical implementation in Epic 16).
  - **Context Preservation:** Implement breadcrumb-like indicators (e.g., "Day 5 > Method 1 of 3") during multi-method practice sessions.
  - **Smart Returns:** Ensure that after completing a practice or logging, the app returns the user to a meaningful next action or overview screen, not just the immediate previous screen.

## Acceptance Criteria (ACs)

- AC1: Breadcrumb-style context (e.g., "Day X > Method Y of Z") is displayed during multi-method sessions.
- AC2: Navigation logic implements "smart returns" to contextually relevant screens post-activity.
- AC3: Design for continuous flow transitions in multi-method sessions is established.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Create:
    - `/Users/tradeflowj/Desktop/Growth/Growth/Core/UI/Components/Navigation/BreadcrumbView.swift`
    - `/Users/tradeflowj/Desktop/Growth/Growth/Core/Navigation/NavigationContext.swift`
    - `/Users/tradeflowj/Desktop/Growth/Growth/Core/Navigation/SmartNavigationService.swift`

  - Files to Modify:
    - `/Users/tradeflowj/Desktop/Growth/Growth/Features/Timer/Views/TimerView.swift` (add breadcrumb)
    - `/Users/tradeflowj/Desktop/Growth/Growth/Features/Routines/Views/DailyRoutineView.swift` (add context)
    - `/Users/tradeflowj/Desktop/Growth/Growth/Features/SessionLogging/Views/LogSessionView.swift` (implement smart returns)
    - `/Users/tradeflowj/Desktop/Growth/Growth/Features/Practice/Views/PracticeTabView.swift` (handle return context)
    - `/Users/tradeflowj/Desktop/Growth/Growth/MainView.swift` (integrate navigation service)

- **Key Technologies:**

  - SwiftUI NavigationStack and navigationDestination for navigation management
  - @StateObject and @EnvironmentObject for navigation context sharing
  - Combine framework for reactive navigation state updates
  - Custom transition modifiers for seamless flow animations

- **API Interactions / SDK Usage:**

  - Use existing RoutinesViewModel for accessing current routine context
  - Use existing DailyRoutineViewModel for method progression state
  - Create NavigationContext as an ObservableObject for app-wide navigation state
  - Leverage NotificationCenter for cross-tab navigation events

- **UI/UX Notes:**

  - Breadcrumb should appear below navigation bar in practice-related views
  - Use subtle animations for context transitions (fade in/out)
  - Smart returns should feel predictable: Practice → Log → Summary → Dashboard/Progress
  - Breadcrumb format: "Day {N} • Method {X} of {Y}" with muted secondary text style
  - Consider using SF Symbols for visual separation (chevron.right.2)

- **Data Structures:**

  - NavigationContext model:
    ```swift
    class NavigationContext: ObservableObject {
        @Published var routineDayNumber: Int?
        @Published var currentMethodIndex: Int?
        @Published var totalMethods: Int?
        @Published var returnDestination: ReturnDestination = .dashboard
        @Published var practiceFlowActive: Bool = false
    }
    
    enum ReturnDestination {
        case dashboard
        case practiceTab
        case progressTab
        case routineDetail(routineId: String)
    }
    ```

- **Environment Variables:**

  - No new environment variables needed for this story

- **Coding Standards Notes:**
  - Follow SwiftUI best practices for @EnvironmentObject injection
  - Use computed properties for breadcrumb text generation
  - Implement proper cleanup of navigation context on flow completion
  - Follow existing navigation patterns established in the app

## Tasks / Subtasks

- [x] Create Navigation Infrastructure
  - [x] Create NavigationContext class with Published properties for context state
  - [x] Create SmartNavigationService for managing return destinations
  - [x] Add navigation context as @StateObject in MainView
  - [x] Inject navigation context as @EnvironmentObject where needed
- [x] Implement Breadcrumb Component
  - [x] Create BreadcrumbView with flexible text formatting
  - [x] Add support for different breadcrumb styles (practice, routine, progress)
  - [x] Implement fade animations for context changes
  - [x] Add accessibility labels for screen reader support
- [x] Integrate Context in Practice Flows
  - [x] Update DailyRoutineView to set navigation context on appear
  - [x] Modify TimerView to display breadcrumb during practice
  - [x] Update method progression to update breadcrumb context
  - [x] Ensure context persists across sheet presentations
- [x] Implement Smart Returns
  - [x] Update LogSessionView to check navigation context for return destination
  - [x] Implement return to dashboard after routine completion
  - [x] Add return to progress tab after quick practice logging
  - [x] Handle edge cases (app backgrounding, interruptions)
- [x] Add Continuous Flow Transitions
  - [x] Design transition protocol for multi-method progression
  - [x] Implement method-to-method transitions in DailyRoutineView
  - [x] Add completion celebration before smart return
  - [x] Ensure smooth animation between navigation states
- [x] Testing and Polish
  - [x] Test breadcrumb updates during method progression
  - [x] Verify smart returns work from all completion points
  - [x] Test navigation context persistence across app states
  - [x] Add haptic feedback for navigation transitions

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:**
  - Test NavigationContext state updates and computed properties
  - Test SmartNavigationService return destination logic
  - Test BreadcrumbView text generation for various contexts
  - Verify navigation context cleanup on flow completion

- **Integration Tests:**
  - Test complete flow: Dashboard → Practice → Timer → Log → Smart Return
  - Test breadcrumb updates during multi-method routine progression
  - Test navigation context persistence across sheet dismissals
  - Verify proper return destinations based on entry points

- **Manual/CLI Verification:**
  - Start a routine from dashboard, verify breadcrumb appears in timer
  - Progress through multi-method routine, confirm breadcrumb updates
  - Complete practice and log, verify smart return to dashboard
  - Start quick practice from practice tab, verify return to practice tab
  - Test interruption scenarios (app backgrounding, force quit)
  - Verify breadcrumb visibility and animations on different device sizes

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `Claude 3 Opus`
- **Completion Notes:** 
  - Successfully implemented all navigation context features including breadcrumb display, smart returns, and continuous flow transitions
  - Created reusable NavigationContext and SmartNavigationService for app-wide navigation state management
  - BreadcrumbView supports multiple styles and includes animations and accessibility
  - Smart returns navigate users to contextually appropriate destinations after completing flows
  - Added haptic feedback for navigation transitions using UIKit feedback generators
  - Integration points established in DailyRoutineView, TimerView, LogSessionView, and PracticeTabView
  - The foundation is now ready for Epic 16's multi-method practice implementation
- **Change Log:**
  - Initial Draft - 2025-05-30
  - Implementation Complete - 2025-05-30