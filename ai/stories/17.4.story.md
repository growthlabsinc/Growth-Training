# Story 17.4: Add Contextual Insights to Progress Data

**Status:** Review

## Goal & Context

**User Story:** As a User, I want the app to provide contextual insights based on my progress data, helping me understand my performance better and identify areas for improvement.

**Context:** This story completes the unified progress visualization epic by adding intelligence to the data presentation. Building upon the consolidated dashboard (17.1), adherence tracking (17.2), and detailed views (17.3), this story transforms raw progress data into actionable insights. Rather than users having to interpret their own metrics, the app will proactively surface meaningful observations and gentle recommendations to enhance their growth journey.

## Detailed Requirements

- Based on analyzed progress data (trends, adherence, session details), provide simple, actionable insights to the user.
- Examples:
  - "You've increased your Vascion practice time by 20% this month!"
  - "Your adherence to the 'Beginner Growth' routine is excellent this week!"
  - "Noticing a drop in session frequency? Try scheduling your next session."
- These insights can be displayed on the Progress Overview Dashboard or as occasional highlights.
- Initial implementation can be rule-based; more complex AI-driven insights can be part of Epic 18.

## Acceptance Criteria (ACs)

- AC1: The app displays at least 3-5 types of rule-based contextual insights based on user's progress data.
- AC2: Insights are presented in a clear, positive, and actionable manner.
- AC3: Insights are displayed on the Progress Overview Dashboard or as relevant highlights.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards and understand the project structure. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Create: 
    - `Growth/Features/Progress/Models/ProgressInsight.swift`
    - `Growth/Features/Progress/Services/InsightGenerationService.swift`
    - `Growth/Features/Progress/Components/InsightCardView.swift`
    - `GrowthTests/Features/Progress/InsightGenerationServiceTests.swift`
  
  - Files to Modify: 
    - `Growth/Features/Progress/ViewModels/ProgressViewModel.swift`
    - `Growth/Features/Progress/Views/ProgressOverviewView.swift`
    - `Growth/Features/Progress/Models/ProgressOverviewData.swift`

- **Key Technologies:**

  - SwiftUI for insight card components
  - Combine framework for reactive updates when new insights are generated
  - Foundation's Calendar and DateComponents for time-based calculations

- **API Interactions / SDK Usage:**

  - No external API calls required for rule-based insights
  - Uses existing FirestoreService for accessing session logs and routine data
  - Leverages existing RoutineAdherenceService for adherence-based insights

- **UI/UX Notes:**

  - Insight cards should use the app's existing card styling (CardView component)
  - Use AppTheme colors: success (green) for positive insights, warning (orange) for suggestions
  - Icons should match the insight type (trending up, calendar check, flame for streaks)
  - Cards should be dismissible with a subtle X button
  - Maximum 2-3 insights shown at once to avoid overwhelming the dashboard

- **Data Structures:**

  ```swift
  struct ProgressInsight: Identifiable {
      let id: String
      let type: InsightType
      let title: String
      let message: String
      let icon: String // SF Symbol name
      let actionText: String?
      let priority: Int // For sorting/filtering
      let generatedAt: Date
      let expiresAt: Date?
  }
  
  enum InsightType: String, CaseIterable {
      case trendPositive = "trend_positive"
      case trendNegative = "trend_negative"
      case adherenceHigh = "adherence_high"
      case adherenceLow = "adherence_low"
      case streakMilestone = "streak_milestone"
      case consistencyPattern = "consistency_pattern"
      case inactivityWarning = "inactivity_warning"
  }
  ```

- **Environment Variables:**

  - None required for this story

- **Coding Standards Notes:**
  - Follow existing patterns in ProgressViewModel for data aggregation
  - Use dependency injection for InsightGenerationService
  - Ensure all string messages are prepared for future localization
  - Keep insight generation logic pure/testable by separating from UI

## Tasks / Subtasks

- [x] Create ProgressInsight model and InsightType enum
- [x] Implement InsightGenerationService
  - [x] Add trend analysis methods (compare current vs previous period)
  - [x] Add adherence-based insight generation
  - [x] Add streak and consistency pattern detection
  - [x] Add inactivity detection logic
- [x] Create InsightCardView component
  - [x] Implement card styling with icon, title, and message
  - [x] Add dismiss functionality
  - [x] Support optional action button
- [x] Integrate insights into ProgressViewModel
  - [x] Add published insights property
  - [x] Call insight generation when progress data updates
  - [x] Implement insight filtering/prioritization logic
- [x] Update ProgressOverviewView to display insights
  - [x] Add insights section above or below calendar summary
  - [x] Limit to 2-3 most relevant insights
- [x] Update ProgressOverviewData model to include insights
- [x] Write comprehensive unit tests
- [x] Test with various data scenarios (new user, active user, returning after break)

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

- **Unit Tests:** 
  - Test each insight generation rule with mock data
  - Verify correct insight types are generated for different scenarios
  - Test date calculations for trends and inactivity detection
  - Ensure insights expire appropriately
  - Test priority sorting logic

- **Integration Tests:** 
  - Verify insights update when new session logs are added
  - Test that dismissed insights don't reappear immediately
  - Ensure insight generation doesn't impact app performance

- **Manual/CLI Verification:** 
  - Create test data with various patterns (improving, declining, consistent, sporadic)
  - Verify at least 3-5 different insight types appear
  - Check UI presentation on different device sizes
  - Confirm positive tone and actionable messaging
  - Test dismiss functionality

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `Claude 3 Opus`
- **Completion Notes:** 
  - Successfully implemented all requirements with 5 different insight types
  - Insights are rule-based as specified, using existing progress data
  - Added dismiss functionality and action buttons for engagement
  - Integrated seamlessly into the Progress Overview Dashboard
  - Note: RoutineAdherenceData model didn't have routineName property, so adapted insights to work without it
  - All unit tests created and build succeeds
- **Change Log:** 
  - Initial Draft - 2025-05-31
  - Implementation Complete - 2025-05-31