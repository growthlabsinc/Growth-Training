# Story 4.4: Edit Existing Session Log

**Status:** Complete
**Epic:** 4 - Session Logging & History
**Estimated Story Points:** 5
**Assigned Agent:** (To be assigned)
**Target Sprint:** (To be determined)

## 1. Goal & Context

**User Story:** As a User, I want to be able to edit the details of a previously logged session, so I can correct mistakes or add more information I recalled later.

**Business Value:** Enhances data accuracy and user control over their logged experiences, improving the reliability and personalization of their session history.

**Context:** This story directly follows the implementation of the Session Detail View (Story 4.3). It leverages the existing infrastructure for viewing session logs and introduces modification capabilities. The primary interaction point for initiating an edit will be from the `SessionDetailView`. Editing will likely involve reusing or adapting the existing `LogSessionView` and its `LogSessionViewModel` to operate in an "edit mode," pre-filled with the selected session's data.

## 2. Detailed Requirements

- **R1: Edit Initiation:** An "Edit" action/button **must be** available on the `SessionDetailView`.
- **R2: Navigation to Edit Interface:** Activating the "Edit" action **must** navigate the user to an editing interface pre-populated with the data from the selected `SessionLog`.
    - R2.1: This interface **should** be a modified version of the `LogSessionView` or a new, dedicated `EditSessionView` if complexity warrants.
- **R3: Editable Fields:** The user **must** be able to modify the following fields of a `SessionLog`:
    - R3.1: Start Time (Date and Time components).
    - R3.2: Duration.
    - R3.3: User Notes.
    - R3.4: MoodBefore.
    - R3.5: MoodAfter.
- **R4: Non-Editable Fields:** The `methodId` and `userId` associated with the `SessionLog` **must not** be editable through this interface. The `id` of the `SessionLog` itself is also immutable.
- **R5: Persist Changes:** Upon user confirmation (e.g., tapping a "Save" button), the modifications **must be** persisted to the corresponding `SessionLog` document in Firestore.
- **R6: Post-Save Navigation:** After successfully saving changes, the user **must be** navigated back to the `SessionDetailView`, which **must** display the updated information. The underlying `SessionHistoryView` **should** also reflect these changes if the edited item is visible.
- **R7: Cancel Edit:** The user **must** have an option to "Cancel" the editing process, discarding any changes and returning to the `SessionDetailView` without altering the original log.
- **R8: UI/UX Adherence:** All UI components and interactions **must** strictly adhere to the project's `docs/style-guide.md`, `docs/ui-ux-spec.md`, and the established Figma designs.
- **R9: Error Handling:** Robust error handling **must be** implemented for Firestore update operations, with clear feedback provided to the user in case of failure.

## 3. Acceptance Criteria (ACs)

- **AC1: Edit Option Availability:**
    - GIVEN a user is viewing the `SessionDetailView` for a specific log
    - WHEN the view loads
    - THEN an "Edit" button/option is clearly visible and enabled.
- **AC2: Pre-filled Edit Form:**
    - GIVEN the user taps the "Edit" option on `SessionDetailView`
    - WHEN the editing interface loads
    - THEN all editable fields (Start Time, Duration, Notes, MoodBefore, MoodAfter) are pre-populated with the current data of the selected `SessionLog`.
- **AC3: Successful Save and Update:**
    - GIVEN the user has modified data in the editing interface
    - WHEN the user confirms to "Save" the changes
    - THEN the `SessionLog` document in Firestore is updated with the new data.
    - AND the user is navigated back to the `SessionDetailView`.
    - AND `SessionDetailView` displays the updated information from the log.
    - AND (if applicable) the `SessionHistoryView` list reflects the updated log data.
- **AC4: Cancel Edit Operation:**
    - GIVEN the user has modified data in the editing interface
    - WHEN the user chooses to "Cancel"
    - THEN no changes are persisted to Firestore.
    - AND the user is navigated back to the `SessionDetailView`, displaying the original, unmodified log data.
- **AC5: Immutability of Core IDs:**
    - GIVEN the user is in the editing interface
    - THEN there are no UI elements allowing modification of `SessionLog.id`, `SessionLog.userId`, or `SessionLog.methodId`.

## 4. Technical Implementation Context

**Guidance:** The Developer Agent assigned to this story is expected to implement the solution by adhering to the project's established architecture, patterns, and coding standards as detailed in `docs/architecture.md`, `docs/project-structure.md`, and `docs/coding-standards.md`.

### 4.1. Key Files & Modules for Modification/Creation:

-   **`Growth/Features/SessionLogging/Views/SessionDetailView.swift`**:
    -   **Responsibility:** Initiate the edit workflow.
    -   **Modification:** Add an "Edit" `ToolbarItem` (e.g., using `Image(systemName: "pencil")`). This item should trigger navigation to the session editing interface, passing the `SessionLog` object that needs to be edited. Consider managing navigation state via the `SessionDetailViewModel`.
-   **`Growth/Features/SessionLogging/Views/LogSessionView.swift` (or new `EditSessionView.swift`):**
    -   **Responsibility:** Provide the UI for editing `SessionLog` details.
    -   **Modification/Creation:** Adapt this view to operate in an "edit mode."
        -   It **must** accept an optional `SessionLog` object in its initializer. If a `SessionLog` is provided, the view pre-populates its form fields (Date, Time, Duration, Notes, Moods) from this object.
        -   The view's title or a prominent header **should** indicate "Edit Session" when in this mode.
        -   The primary action button **must** change from "Log Session" to "Save Changes" (or similar).
-   **`Growth/Features/SessionLogging/ViewModels/LogSessionViewModel.swift` (or new `EditSessionViewModel.swift`):**
    -   **Responsibility:** Manage the state and logic for the session editing interface.
    -   **Modification/Creation:**
        -   Update the ViewModel to accept an optional `SessionLog` (the "editingLog") during initialization.
        -   If an `editingLog` is provided, the ViewModel **must** initialize its published properties (bound to the View's form fields) with the values from this `editingLog`.
        -   The existing `saveSession()` function (or equivalent) **must be** modified or augmented. When an `editingLog` is present, this function **must** construct an updated `SessionLog` object (retaining the original `id`, `userId`, `methodId`) and call the appropriate `FirestoreService` method to update the existing document, rather than creating a new one.
-   **`Growth/Core/Services/FirestoreService.swift`**:
    -   **Responsibility:** Abstract Firestore data operations.
    -   **Modification:** The existing `saveSessionLog(log: SessionLog, completion: @escaping (Error?) -> Void)` function **can be used** for updates if the `SessionLog` object passed to it contains the correct `id` of the document to be updated. Firestore's `document(log.id).setData(...)` will overwrite the document at that path, effectively performing an update.
        -   **Ensure** that the `log.toFirestoreData()` method correctly serializes all fields that are intended to be updated.
        -   Alternatively, a dedicated `updateSessionLog(log: SessionLog, completion: @escaping (Error?) -> Void)` could be added for clarity, using `db.collection("sessionLogs").document(log.id).updateData(log.toFirestoreData()) { ... }` or `setData(..., merge: true)` if partial updates were intended (though full object update is fine here). For simplicity and consistency, verify `saveSessionLog` suffices.
-   **`Growth/Features/SessionLogging/ViewModels/SessionDetailViewModel.swift`**:
    -   **Responsibility:** Manage data for `SessionDetailView` and coordinate actions.
    -   **Modification:** Add a mechanism to present the editing view (e.g., a `@Published var isPresentingEditView: Bool`). This ViewModel will also need to be refreshed or re-fetch its `SessionLog` if the edit is successful and the editing view dismisses back to it, ensuring UI consistency. This can be achieved via a callback/closure from the edit ViewModel or by re-triggering its data load. A `Notification` similar to `.sessionLogDeleted` (e.g., `.sessionLogUpdated`) could also be used.

### 4.2. Key Technologies:

-   **SwiftUI:** For UI construction, state management (`@State`, `@StateObject`, `@EnvironmentObject`), and navigation.
-   **Combine:** For reactive data flow within and between ViewModels.
-   **Firebase Firestore:** As the backend database for persisting `SessionLog` updates.

### 4.3. API Interactions / SDK Usage:

-   **Firestore Document Update:**
    -   The core operation is updating an existing document in the `sessionLogs` collection.
    -   Retrieve the document ID from the `SessionLog` being edited.
    -   Use `Firestore.firestore().collection("sessionLogs").document(log.id).setData(log.toFirestoreData()) { error in ... }`. This will overwrite the document at the given ID with the new data. Ensure all fields from the `SessionLog` object are correctly represented in `toFirestoreData()`.

### 4.4. UI/UX Mandates:

-   The "Edit" action **must be** intuitively placed within `SessionDetailView` (e.g., toolbar icon `pencil`).
-   The editing interface, if reusing `LogSessionView`, **must** clearly differentiate itself (e.g., "Edit Session" title, "Save Changes" button text).
-   Standard loading indicators **should be** used during the save operation.
-   User feedback for successful save or any errors **must be** clear and follow patterns in `docs/ui-ux-spec.md`.
-   Navigation flow: `SessionHistoryView` -> `SessionDetailView` -> `EditSessionView` -> (on save/cancel) `SessionDetailView`.

### 4.5. Data Model References:

-   Primary data model: `Growth/Core/Models/SessionLog.swift`. No changes to the model structure itself are anticipated for this story.
-   Reference `Growth/Core/Models/GrowthMethod.swift` only if its details are displayed on the edit screen (though typically not editable).

### 4.6. Coding Standards & Best Practices:

-   Strict adherence to `docs/coding-standards.md` is required.
-   ViewModel responsibilities **must be** respected to keep Views lightweight.
-   Error handling for Firestore operations **must be** comprehensive.
-   State management within the editing view (e.g., for form fields, loading state) **must be** robust.
-   Consider using `disabled()` modifiers on the "Save" button based on form validation state (if any complex validation is introduced beyond basic field presence).

## 5. Tasks / Subtasks (Developer Agent Checklist)

-   [ ] **Task 4.4.1:** Add "Edit" `ToolbarItem` to `SessionDetailView.swift`.
    -   [ ] Implement presentation logic (e.g., sheet or navigation) for the editing view, passing the selected `SessionLog`.
-   [ ] **Task 4.4.2:** Adapt `LogSessionView.swift` and `LogSessionViewModel.swift` for "Edit Mode".
    -   [ ] Modify initializers to accept an optional `SessionLog` for editing.
    -   [ ] If `SessionLog` is provided, pre-populate all form fields (Date, Time, Duration, Notes, Moods) in the ViewModel and View.
    -   [ ] Update UI text (view title, save button) to reflect "Edit Mode".
-   [ ] **Task 4.4.3:** Implement Update Logic in `LogSessionViewModel.swift`.
    -   [ ] Modify the save function to check if it's an "edit" operation.
    -   [ ] If editing, construct an updated `SessionLog` object (maintaining original `id`).
    -   [ ] Call `FirestoreService.saveSessionLog` (or a new `updateSessionLog`) with the updated object.
    -   [ ] Handle success: dismiss edit view, trigger refresh in `SessionDetailView` (e.g., via callback, Notification, or shared state).
    -   [ ] Handle errors: display appropriate error messages.
-   [ ] **Task 4.4.4:** Implement "Cancel" functionality in the editing view.
    -   [ ] Provide a "Cancel" button.
    -   [ ] Dismiss the editing view without saving changes.
-   [ ] **Task 4.4.5:** Ensure Data Refresh in `SessionDetailView` & `SessionHistoryView`.
    -   [ ] Upon successful edit and dismissal of the edit view, `SessionDetailView` **must** reflect the updated data.
    -   [ ] `SessionHistoryView` **should** also reflect changes if the item is visible in its list (may require similar notification pattern as delete).
-   [ ] **Task 4.4.6:** (If needed) Refine `FirestoreService.saveSessionLog` or add `updateSessionLog` to ensure robust updates.
-   [ ] **Task 4.4.7:** Testing.
    -   [ ] Write Unit Tests for ViewModel logic (pre-population, update process).
    -   [ ] Conduct Integration Tests for the full edit flow including Firestore interaction.
    -   [ ] Perform Manual Verification as per Testing Requirements.

## 6. Testing Requirements

-   **Unit Tests:**
    -   `LogSessionViewModel` (or `EditSessionViewModel`):
        -   Verify correct pre-population of form fields from an existing `SessionLog`.
        -   Verify correct construction of the updated `SessionLog` object.
        -   Mock `FirestoreService` to test save/update interaction and error handling.
-   **Integration Tests:**
    -   Test navigation from `SessionDetailView` to the editing interface and back.
    -   Verify data persistence: edit a log, save, re-fetch from Firestore, and assert updated values.
-   **Manual Verification:**
    -   Confirm "Edit" option presence and functionality on `SessionDetailView`.
    -   Verify all editable fields are correctly pre-filled in the edit interface.
    -   Modify each editable field (Date, Time, Duration, Notes, Moods) and save; confirm changes are reflected on `SessionDetailView` and in Firestore.
    -   Test "Cancel" functionality: make changes, cancel, and verify no data was persisted and `SessionDetailView` shows original data.
    -   Validate UI against `docs/style-guide.md`, `docs/ui-ux-spec.md`, and Figma.

## 7. Story Wrap Up (Agent Populates After Execution)

-   **Agent Model Used:** `Gemini 2.5 Pro`
-   **Completion Notes:** 
    -   Added an "Edit" button to `SessionDetailView` that presents `LogSessionView` as a sheet.
    -   Created `LogSessionViewModel` to handle logic for both creating and editing session logs, including pre-filling data for edits.
    -   Refactored `LogSessionView` to use `LogSessionViewModel` and adapt its UI (title, button text, cancel button) for edit mode.
    -   `LogSessionViewModel` now calls `FirestoreService.saveSessionLog` for both new logs and updates (as `setData` overwrites).
    -   Implemented `.sessionLogUpdated` notification upon successful edit, which is observed by `SessionDetailView` and `SessionHistoryView` to refresh their data.
    -   `SessionDetailView` updates its displayed `sessionLog`.
    -   `SessionHistoryViewModel` updates the specific log in its `sessionLogs` array.
    -   Confirmed `FirestoreService.saveSessionLog` is suitable for updates without modification.
-   **Change Log:**
    -   Initial Draft - `YYYY-MM-DD` (Placeholder, actual date would be set by Scrum Master)
    -   Full implementation of edit functionality, including ViewModel creation for LogSessionView, UI adaptations, and data refresh mechanisms across relevant views. 