# Story 19.3: Implement Initial User Assessment for Method Routing

**Status:** Complete

## Goal & Context

**User Story:** As a New User, after creating my account, I want to answer a simple question that helps the app guide me to the most appropriate starting Growth Method based on my physical ability.

**Context:** This story builds upon the consent flow (Story 19.2) and account creation by implementing the initial assessment screen that routes users to either "Angio Pumping" or "Angion Method 1.0 (Beginner)" based on their physical ability. This assessment screen will be inserted into the existing onboarding flow as a new step between account creation and profile setup. The existing OnboardingFlowCoordinator manages the flow between steps, and the OnboardingViewModel tracks progress. This story will add a new onboarding step and assessment screen to capture the user's starting point.

## Detailed Requirements

- Implement the "Initial Assessment" screen.
- UI Elements:
  - Supportive question: "Let's find your ideal starting point."
  - Single, clear question based on Angion documentation: "Can you achieve and maintain an erection suitable for practice without aids?"
  - Two large, clear buttons: "Yes, I can" and "No, I need assistance."
- Logic:
  - If "No, I need assistance," set the user's starting point/current focused stage to "Angio Pumping."
  - If "Yes, I can," set the user's starting point/current focused stage to "Angion Method 1.0 (Beginner)."
- Store this initial assessment outcome or derived starting stage in the user's profile.

## Acceptance Criteria (ACs)

- AC1: The Initial Assessment screen is displayed after account creation.
- AC2: All UI elements (question, two distinct answer buttons) are present and clear.
- AC3: User selection correctly routes them to either "Angio Pumping" or "Angion Method 1.0 (Beginner)" as their initial focused method in their profile.
- AC4: The interaction feels supportive and non-clinical.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Create: 
    - `Growth/Features/Onboarding/Views/InitialAssessmentView.swift`
  - Files to Modify: 
    - `Growth/Features/Onboarding/ViewModels/OnboardingViewModel.swift` (add new assessment step)
    - `Growth/Features/Onboarding/Views/OnboardingFlowCoordinator.swift` (add assessment view to flow)
    - `Growth/Core/Models/User.swift` (add field for initial method/starting point)
    - `Growth/Core/Services/UserService.swift` (update method to save initial assessment)

- **Key Technologies:**

  - SwiftUI for UI implementation
  - Existing AppTheme colors and typography system
  - Haptic feedback via ThemeManager
  - Existing button styles (PrimaryButtonStyle)

- **API Interactions / SDK Usage:**

  - UserService to update user profile with initial method selection
  - FirestoreService for persisting the user's starting method

- **UI/UX Notes:**

  - Use existing color scheme from AppTheme.Colors:
    - Primary color: "GrowthGreen" for positive response button
    - Secondary/neutral color for the alternative response button
    - Background: "GrowthBackgroundLight"
  - Button styling should follow existing PrimaryButtonStyle
  - Text should use AppTheme.Typography styles
  - Maintain the supportive, non-clinical tone
  - Use large, touch-friendly buttons (ComponentSize.primaryButtonHeight)
  - Provide haptic feedback on button selection

- **Data Structures:**

  - Add to User model:
    - `initialMethodId: String?` - The ID of the initially selected method
    - `initialAssessmentResult: String?` - The assessment result ("needs_assistance" or "can_proceed")
    - `initialAssessmentDate: Date?` - When the assessment was completed

- **Environment Variables:**

  - None specific to this story

- **Coding Standards Notes:**
  - Follow SwiftUI best practices for view composition
  - Use @ObservedObject for OnboardingViewModel
  - Implement proper error handling for profile updates
  - Use existing UI components and styles where possible

## Tasks / Subtasks

- [x] Create InitialAssessmentView.swift with the assessment question UI
  - [x] Implement the supportive title and question text
  - [x] Create two prominent response buttons
  - [x] Add haptic feedback on button tap
  - [x] Handle button actions to set assessment result
- [x] Update OnboardingStep enum to include .initialAssessment
  - [x] Add case between .account and .profileSetup
  - [x] Update next() and previous() logic
- [x] Modify OnboardingFlowCoordinator to include InitialAssessmentView
  - [x] Add case for .initialAssessment in the switch statement
  - [x] Ensure proper navigation flow
- [x] Update User model with initial assessment fields
  - [x] Add properties for storing assessment result and selected method
  - [x] Update Codable conformance
- [x] Implement assessment result storage in UserService
  - [x] Create method to update user profile with assessment result
  - [x] Map assessment result to appropriate method ID
  - [x] Handle "Angio Pumping" vs "Angion Method 1.0" assignment
- [x] Test the complete flow from account creation through assessment

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:** 
  - Test OnboardingViewModel advancement through new assessment step
  - Test User model encoding/decoding with new fields
  - Test UserService method for storing assessment results
  - Verify correct method ID assignment based on assessment choice
- **Integration Tests:**
  - Test navigation flow from account creation to assessment to profile setup
  - Verify assessment result is properly persisted to Firestore
  - Ensure user profile contains correct initial method after assessment
- **Manual/UI Verification:**
  - Verify assessment screen appears after account creation
  - Test both button selections and verify correct method assignment
  - Ensure haptic feedback works on button tap
  - Verify the supportive, non-clinical tone of the interface
  - Test back navigation from assessment screen

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `claude-opus-4-20250514`
- **Completion Notes:** 
  - Successfully implemented the initial assessment feature that routes users to appropriate starting methods
  - Created a supportive, non-clinical interface with clear visual hierarchy
  - Used existing theme system and button styles for consistency
  - Added haptic feedback for better user experience
  - Integrated with Firebase Auth for user authentication
  - Method IDs used: "angio_pumping" for users needing assistance, "am1_0" for users who can proceed
  - Created comprehensive unit tests for OnboardingViewModel, User model, and UserService
  - All acceptance criteria have been met
- **Change Log:** 
  - Initial Draft
  - Implementation completed with all tasks checked off