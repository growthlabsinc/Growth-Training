# Story 8.1: Push Notification Setup and Implementation

**Status:** Review

## Goal & Context

**User Story:** As a User, I want to receive timely push notifications about my growth activities, session reminders, and achievements so that I stay engaged with my practice even when I'm not actively using the app.

**Context:** Push notifications are a critical engagement tool that will help users maintain their practice routines and celebrate their progress. This story involves setting up Apple Push Notification service (APNs) integration in the app and implementing the necessary code to request permissions, register for notifications, and handle notification events. This lays the foundation for future, more specialized notification features.

## Detailed Requirements

- Configure the app to support push notifications through Apple's Push Notification service (APNs)
- Implement permission request flow for push notifications
- Register the device for remote notifications and handle device token
- Store device tokens in Firebase for later use in sending targeted notifications
- Implement basic notification handling for when the app is in foreground, background, or terminated states
- Create a basic notification preferences screen allowing users to opt in/out of different notification types:
  - Session reminders
  - Streak maintenance
  - Achievement notifications
  - New content notifications
- Add notification analytics to track delivery and engagement metrics

## Acceptance Criteria (ACs)

- AC1: The app properly requests notification permissions from the user upon first launch
- AC2: When permission is granted, the app successfully registers with APNs and obtains a device token
- AC3: Device tokens are securely stored in Firebase and associated with the user's account
- AC4: The app can receive and process push notifications in foreground, background, and terminated states
- AC5: Users can access notification preferences to customize which notifications they receive
- AC6: Analytics for notification delivery and engagement are implemented

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards and understand the project structure.

- **Relevant Files/Components to Create:**
  - `Growth/Features/Notifications/NotificationsManager.swift` (New singleton service to manage notifications)
  - `Growth/Features/Notifications/Views/NotificationPreferencesView.swift` (Settings screen for notification preferences)
  - `Growth/Features/Notifications/ViewModels/NotificationPreferencesViewModel.swift` (ViewModel for notification preferences)
  - `Growth/Core/Models/NotificationPreferences.swift` (Model for user notification preferences)

- **Relevant Files to Modify:**
  - `Growth/Core/Services/FirestoreService.swift` (Add methods to store/retrieve device tokens)
  - `Growth/App/GrowthApp.swift` (Configure UNUserNotificationCenter delegate)
  - `Growth/App/AppDelegate.swift` (Implement notification handling)
  - `Growth/Features/Profile/Views/ProfileView.swift` (Add link to notification preferences)

- **Key Technologies:**
  - UserNotifications framework for iOS notifications
  - Firebase Cloud Messaging for managing device tokens and sending notifications
  - SwiftUI for the notification preferences UI
  - Combine for reactive state management

- **Integration Details:**
  - Create the appropriate certificate and provisioning profile in the Apple Developer Portal
  - Enable Push Notifications capability in Xcode project settings
  - Configure Firebase Cloud Messaging in the Firebase console
  - Update Firebase dependencies to include messaging features
  - Add notification handling methods in the AppDelegate
  - Store device tokens in Firestore under a new `deviceTokens` collection or as a field in the user document

- **UI/UX Notes:**
  - Notification permission request should be presented with a clear explanation of benefits
  - Notification preferences screen should use toggle switches for each notification type
  - The system should respect the user's choices and only send notifications they've opted into
  - Notification handling should direct users to the appropriate section of the app when a notification is tapped

- **Security Considerations:**
  - Ensure device tokens are only stored for authenticated users
  - Follow Apple's guidelines for requesting notification permissions and handling notifications

## Tasks / Subtasks

- [x] Configure project for push notifications
  - [x] Set up the necessary certificates and provisioning profiles in Apple Developer Portal
  - [x] Enable Push Notifications capability in Xcode
  - [x] Configure Firebase Cloud Messaging in Firebase Console
  - [x] Update Firebase dependencies in the project

- [x] Implement notification permission handling
  - [x] Create NotificationsManager service with methods to request permissions
  - [x] Implement UNUserNotificationCenterDelegate methods
  - [x] Add permission request flow with proper timing

- [x] Add device token management
  - [x] Implement methods to register for remote notifications
  - [x] Add functions to handle device token in AppDelegate
  - [x] Develop methods to store device token in Firebase

- [x] Create notification handling logic
  - [x] Implement methods to handle notifications in different app states
  - [x] Add logic to process notification data and navigate appropriately
  - [x] Set up silent notification handling for background updates

- [x] Develop notification preferences
  - [x] Create NotificationPreferences model with user preferences
  - [x] Implement Firestore methods to store and retrieve preferences
  - [x] Build NotificationPreferencesView with toggle options
  - [x] Integrate notification preferences into Firebase

- [x] Implement analytics for notifications
  - [x] Set up tracking for notification permission status
  - [x] Add tracking for notification delivery and interactions
  - [x] Create dashboard for monitoring notification effectiveness

- [x] Test notification functionality
  - [x] Test permission flow on real devices
  - [x] Test receiving notifications in all app states
  - [x] Verify preferences are being respected for various notification types

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

- **Unit Tests:**
  - Test NotificationsManager methods for requesting permissions and handling tokens
  - Test correct storage and retrieval of notification preferences
  - Test analytics capturing for notification events

- **Integration Tests:**
  - Test end-to-end flow from permission request to notification handling
  - Test synchronization of notification preferences between UI and backend

- **Manual Verification:**
  - Verify push notification permission flow on real devices
  - Test receiving notifications in foreground, background, and terminated states
  - Verify that tapping on notifications navigates to the right screen
  - Check that notification preferences are respected when sending push notifications
  - Verify analytics are correctly tracking notification metrics 