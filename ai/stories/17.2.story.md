# Story 17.2: Implement Routine Adherence Tracking & Visualization

**Status:** Review

## Goal & Context

**User Story:** As a User following a routine, I want to see how well I'm adhering to my scheduled plan, so I can stay on track and motivated.

**Context:** This story builds upon the progress overview dashboard from Story 17.1 by implementing routine adherence tracking logic. It integrates adherence metrics into multiple user touchpoints including the Home Dashboard's weekly snapshot, Current Routine view, and Progress Overview Dashboard to provide consistent feedback on routine compliance.

## Detailed Requirements

- Develop logic to track routine adherence:
  - Compare logged sessions against the scheduled methods/days in the user's active routine.
  - Calculate an adherence percentage (e.g., weekly, or for the entire routine).
- Display routine adherence percentage prominently:
  - On the "Weekly Progress Snapshot" on the Home (Dashboard). (Integration with Epic 15)
  - Within the "Current Routine" view in the Routines tab.
  - On the consolidated "Progress Overview Dashboard."
- Visualize adherence (e.g., progress bar, checkmarks on a weekly view).

## Acceptance Criteria (ACs)

- AC1: Routine adherence is calculated based on logged sessions vs. scheduled routine activities.
- AC2: Adherence percentage is displayed in the Home Dashboard's weekly snapshot, Current Routine view, and Progress Overview Dashboard.
- AC3: Visual indicators clearly show adherence status.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Create: 
    - `Growth/Core/Services/RoutineAdherenceService.swift` (Service for adherence calculations)
    - `Growth/Features/Progress/Models/RoutineAdherenceData.swift` (Data model for adherence metrics)
    - `Growth/Features/Dashboard/Components/AdherenceProgressBar.swift` (Reusable adherence visualization)
    - `Growth/Features/Routines/Components/RoutineAdherenceView.swift` (Adherence display for routine views)
  - Files to Modify: 
    - `Growth/Features/Dashboard/ViewModels/TodayViewViewModel.swift` (Replace placeholder adherence value)
    - `Growth/Features/Dashboard/Components/WeeklyProgressSnapshotView.swift` (Update adherence display)
    - `Growth/Features/Progress/ViewModels/ProgressViewModel.swift` (Add adherence data to overview)
    - `Growth/Features/Progress/Components/StatsHighlightView.swift` (Add adherence metric)
    - `Growth/Features/Routines/Views/CurrentRoutineView.swift` (Add adherence card)

- **Key Technologies:**

  - SwiftUI for UI components
  - Combine for reactive data flow
  - Firestore for session log and routine data retrieval
  - TimeRange enum for week/month/quarter/year calculations

- **API Interactions / SDK Usage:**

  - Firestore queries to fetch session logs: `users/{userId}/sessionLogs`
  - RoutineService for active routine and schedule data
  - SessionLog model for practice session data
  - RoutineProgress service for tracking routine position

- **UI/UX Notes:**

  - Use color coding for adherence levels:
    - 80%+ : `GrowthGreen` (excellent adherence)
    - 60-79%: `Color.orange` (good adherence)
    - <60%: `Color.red` (needs improvement)
  - Progress bars with percentage labels
  - Consider rest days as "completed" automatically (don't penalize)
  - Show weekly view by default with option to view monthly

- **Data Structures:**

  - `RoutineAdherenceData`: Model containing:
    - `adherencePercentage: Double`
    - `completedSessions: Int`
    - `expectedSessions: Int`
    - `timeRange: TimeRange`
    - `sessionDetails: [Date: Bool]` (for visualization)
  - Extension to `SessionLog` for adherence matching
  - Helper methods for date range calculations

- **Environment Variables:**

  - None specific to this story - uses existing Firebase configuration

- **Coding Standards Notes:**
  - Follow standards in `docs/coding-standards.md`
  - Use AppTheme.Typography for all text styling
  - Implement proper error handling for missing routine data
  - Cache adherence calculations for performance
  - Handle edge cases (no routine selected, new user, etc.)

## Tasks / Subtasks

- [x] Create RoutineAdherenceService with core calculation logic
  - [x] Implement method to fetch session logs for date range
  - [x] Create logic to match sessions to routine schedule
  - [x] Handle rest days as automatically completed
  - [x] Calculate adherence percentage
  - [x] Support different time ranges (week/month/quarter/year)
- [x] Create RoutineAdherenceData model
  - [x] Define properties for adherence metrics
  - [x] Add computed properties for visualization data
  - [x] Implement Codable for potential caching
- [x] Update TodayViewViewModel
  - [x] Replace placeholder adherence value with real calculation
  - [x] Add RoutineAdherenceService dependency
  - [x] Implement weekly adherence calculation
  - [x] Handle loading and error states
- [x] Create AdherenceProgressBar component
  - [x] Implement customizable progress bar
  - [x] Add percentage label
  - [x] Support different color themes based on value
  - [x] Add animation for value changes
- [x] Update WeeklyProgressSnapshotView
  - [x] Connect to real adherence data from view model
  - [x] Ensure proper color coding based on percentage
  - [x] Add loading state for adherence calculation
- [x] Update ProgressViewModel
  - [x] Add adherence data to overview data structure
  - [x] Implement adherence calculation for selected time range
  - [x] Cache results for performance
- [x] Update StatsHighlightView
  - [x] Add adherence as a highlighted statistic
  - [x] Show appropriate icon and formatting
  - [x] Include trend indicator if applicable
- [x] Create RoutineAdherenceView for CurrentRoutineView
  - [x] Design adherence card layout
  - [x] Show weekly and monthly adherence
  - [x] Add visual calendar with checkmarks
  - [x] Include motivational messaging
- [x] Update CurrentRoutineView
  - [x] Add adherence card after routine header
  - [x] Pass routine data to adherence view
  - [x] Handle no adherence data gracefully
- [x] Add unit tests for adherence calculations
  - [x] Test various scenarios (partial week, rest days, etc.)
  - [x] Verify percentage calculations
  - [x] Test edge cases
- [x] Test integration across all three display locations
- [x] Verify performance with large session log datasets

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:** 
  - Test RoutineAdherenceService calculation methods with various scenarios
  - Verify adherence percentage calculations for different time ranges
  - Test rest day handling and edge cases (no sessions, no routine)
  - Test date range calculations and week boundaries
- **Integration Tests:** 
  - Test data flow from Firestore to adherence displays
  - Verify adherence updates when new sessions are logged
  - Test synchronization across all three display locations
  - Verify performance with realistic data volumes
- **Manual/CLI Verification:** 
  - Create test routine with known schedule
  - Log sessions for partial adherence
  - Verify adherence shows correctly in all three locations:
    - Home Dashboard weekly snapshot
    - Current Routine view
    - Progress Overview Dashboard
  - Test with different adherence levels to verify color coding
  - Test with no routine selected
  - Test with rest days in schedule

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** claude-sonnet-4-20250514
- **Completion Notes:** 
  - Successfully implemented routine adherence tracking and visualization across all three required locations
  - Created RoutineAdherenceService with comprehensive calculation logic handling rest days and different time ranges
  - Built RoutineAdherenceData model with color theming and motivational messaging
  - Integrated adherence calculations into TodayViewViewModel, ProgressViewModel, and CurrentRoutineView
  - Created reusable AdherenceProgressBar and RoutineAdherenceView components following design system
  - WeeklyProgressSnapshotView already had correct color coding logic for adherence display
  - Added unit tests covering various adherence scenarios including rest days and edge cases
  - Resolved TimeRange enum duplication by using existing definition from ProgressTimelineData
  - All acceptance criteria met: adherence calculated, displayed in 3 locations, visual indicators implemented
- **Change Log:**
  - Initial Draft
  - Implementation Complete - All tasks fulfilled, tests added