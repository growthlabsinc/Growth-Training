# Story 20.1: Implement App Tour Trigger & Orchestration Framework

## Story Details

### User Story
As a New User who has just completed onboarding, I want to be offered a brief, optional tour of the app's main features, so I can quickly understand how to navigate and use the application.

### Goal
To implement the foundational framework for an app tour that automatically triggers for first-time users after onboarding completion, providing an orchestrated walkthrough of key app features with proper state management and user controls.

## Detailed Requirements

### 1. Tour Trigger Logic
- Implement automatic tour initiation when a new user first lands on the Home (Dashboard) screen after completing the entire onboarding flow
- Check user profile for a flag indicating whether the tour has been shown, completed, or skipped
- Ensure the tour only appears once per user account, never on subsequent sessions

### 2. Coach Mark / Spotlight Framework
- Implement a reusable "coach mark" or "spotlight" UI component system that:
  - Dims the background with a semi-transparent overlay
  - Creates a highlighted "cutout" around the target UI element
  - Displays an informative popover or tooltip near the highlighted element
  - Supports multiple step sequences with smooth transitions between highlights

### 3. User Controls
- Include a persistent "Skip Tour" or "X" button that is clearly visible and accessible at all times during the tour
- Implement navigation controls to move between tour steps (Next/Previous buttons where appropriate)
- Ensure all interactive elements remain responsive and properly handle user input

### 4. Progress Indication
- Display a clear progress indicator showing current step and total steps (e.g., "Step 1 of 5")
- Update progress dynamically as user advances through or skips steps
- Consider using a progress bar or dot indicators in addition to text

### 5. State Management
- Create a tour state manager to track:
  - Current tour step
  - Completion status
  - Skip/exit actions
- Persist tour completion status to user profile in Firebase
- Handle edge cases like app backgrounding or navigation interruptions during tour

### 6. Tour Configuration
- Design a flexible configuration system to define:
  - Tour steps and their order
  - Target UI elements for each step
  - Associated content (text, images) for each coach mark
  - Step-specific actions or callbacks

## Technical Implementation Details

### Files to Create/Modify

1. **Create Tour Components**:
   - `Growth/Core/UI/Components/AppTour/AppTourOverlay.swift` - Main tour overlay component
   - `Growth/Core/UI/Components/AppTour/CoachMark.swift` - Reusable coach mark/spotlight component
   - `Growth/Core/UI/Components/AppTour/TourProgressIndicator.swift` - Progress indication component
   - `Growth/Core/UI/Components/AppTour/TourControls.swift` - Navigation and skip controls

2. **Create Tour Management**:
   - `Growth/Features/AppTour/ViewModels/AppTourViewModel.swift` - Tour state management and logic
   - `Growth/Features/AppTour/Models/AppTourStep.swift` - Tour step configuration model
   - `Growth/Features/AppTour/Services/AppTourService.swift` - Tour persistence and configuration service

3. **Modify Existing Files**:
   - `Growth/MainView.swift` - Add tour overlay and trigger logic
   - `Growth/Core/Models/User.swift` - Add `hasCompletedAppTour` property
   - `Growth/Core/Services/UserService.swift` - Add tour completion tracking methods
   - `Growth/Features/Onboarding/Views/OnboardingCompletionView.swift` - Set flag for tour triggering

### Technologies & Patterns

1. **SwiftUI Components**:
   - Use `ZStack` for overlay positioning
   - `GeometryReader` for dynamic element positioning
   - `PreferenceKey` for capturing target view frames
   - `AnimatedOffset` and `transition` for smooth step transitions

2. **State Management**:
   - `@StateObject` for AppTourViewModel in MainView
   - `@EnvironmentObject` to pass tour state to child views
   - Combine for reactive state updates

3. **Persistence**:
   - Firebase Firestore for tour completion flag
   - UserDefaults as fallback for offline scenarios

### Key Implementation Patterns

```swift
// Tour Step Configuration
struct AppTourStep {
    let id: String
    let targetViewId: String
    let title: String
    let description: String
    let highlightPadding: CGFloat
    let position: PopoverPosition
}

// Coach Mark View Modifier
struct CoachMarkModifier: ViewModifier {
    let stepId: String
    @EnvironmentObject var tourViewModel: AppTourViewModel
    
    func body(content: Content) -> some View {
        content
            .background(
                GeometryReader { geometry in
                    Color.clear.preference(
                        key: TourFramePreferenceKey.self,
                        value: [stepId: geometry.frame(in: .global)]
                    )
                }
            )
    }
}

// Tour Overlay Implementation
struct AppTourOverlay: View {
    @ObservedObject var viewModel: AppTourViewModel
    
    var body: some View {
        if viewModel.isActive {
            ZStack {
                // Dimmed background with cutout
                Color.black.opacity(0.75)
                    .ignoresSafeArea()
                    .reverseMask {
                        if let frame = viewModel.currentTargetFrame {
                            RoundedRectangle(cornerRadius: 12)
                                .frame(width: frame.width, height: frame.height)
                                .position(x: frame.midX, y: frame.midY)
                        }
                    }
                
                // Coach mark content
                if let step = viewModel.currentStep {
                    CoachMark(step: step, onNext: viewModel.nextStep, onSkip: viewModel.skipTour)
                        .position(for: step.position, targetFrame: viewModel.currentTargetFrame)
                }
            }
            .transition(.opacity)
            .animation(.easeInOut, value: viewModel.currentStepIndex)
        }
    }
}
```

## Testing Requirements

### Unit Tests
1. **AppTourViewModel Tests**:
   - Test tour initialization for new vs returning users
   - Test step navigation (next, previous, skip)
   - Test completion state persistence
   - Test edge cases (invalid steps, interruptions)

2. **AppTourService Tests**:
   - Test tour configuration loading
   - Test user profile flag updates
   - Test offline scenarios

### UI Tests
1. **Tour Flow Tests**:
   - Test automatic tour trigger after onboarding
   - Test all tour steps appear in correct order
   - Test skip functionality at each step
   - Test tour doesn't reappear after completion

2. **Visual Tests**:
   - Verify coach marks highlight correct elements
   - Verify overlay doesn't block critical UI
   - Test on different screen sizes (iPhone SE to iPad)

## Acceptance Criteria

1. **AC1: Automatic Tour Initiation**
   - GIVEN a new user has completed onboarding
   - WHEN they arrive at the Dashboard for the first time
   - THEN the app tour automatically starts

2. **AC2: No Tour for Returning Users**
   - GIVEN a user has previously completed or skipped the tour
   - WHEN they open the app on subsequent sessions
   - THEN the tour does not appear

3. **AC3: Skip/Exit Functionality**
   - GIVEN the tour is active
   - WHEN the user taps the "Skip Tour" button
   - THEN the tour ends immediately and saves this preference

4. **AC4: Progress Indication**
   - GIVEN the tour is active
   - WHEN viewing any tour step
   - THEN a progress indicator shows the current step number and total steps

## Related Documentation
- Epic 20: `docs/epic20.md`
- Onboarding Flow: Stories 19.1-19.7
- MainView Structure: `Growth/MainView.swift`
- User Model: `docs/data-models.md#user`

## Dependencies
- Story 19.7 (Onboarding completion) must be implemented
- User authentication system must be functional
- Firebase integration for user profile persistence

## Status: Done

## Implementation Progress

### Completed Tasks:
- [x] Created AppTourStep model with tour configuration
- [x] Created AppTourService for persistence and state management
- [x] Created AppTourViewModel for tour orchestration
- [x] Created UI Components:
  - [x] AppTourOverlay - Main overlay component
  - [x] CoachMark - Individual spotlight/popover component
  - [x] TourProgressIndicator - Progress display component
  - [x] TourControls - Navigation and skip controls
- [x] Updated User model with tour-related properties
- [x] Updated UserService with tour tracking methods
- [x] Integrated tour overlay in MainView
- [x] Created comprehensive unit tests for ViewModel and Service
- [x] Created UI tests for tour flow
- [x] Added accessibility identifiers for UI testing

### Notes:
- Tour framework is fully implemented and ready for tour steps (stories 20.2-20.6)
- Tour automatically triggers after onboarding completion
- Tour state persists to Firebase and UserDefaults
- Framework supports flexible step configuration and customization
- Added development tools for easy testing and reset functionality
- All development features are wrapped in #if DEBUG for easy removal

## Developer Notes
- The tour framework should be extensible to easily add new tour steps in future stories (20.2-20.6)
- Consider accessibility: ensure VoiceOver properly announces tour elements
- The overlay should handle device rotation gracefully
- Performance: lazy load tour steps to minimize initial impact