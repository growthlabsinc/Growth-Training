# Story 19.5: Implement Contextual Notification Permissions Screen

**Status:** Complete

## Goal & Context

**User Story:** As a New User, towards the end of my onboarding, I want to be asked for notification permissions with a clear explanation of why they are beneficial, so I can make an informed choice.

**Context:** This story builds upon the routine & goal selection (Story 19.4) by implementing the notification permissions screen. This is the final substantive onboarding step before the user enters the main app. The screen needs to clearly communicate the value of notifications in the Growth app context (routine reminders, progress celebrations) while respecting the user's choice. The existing NotificationsManager already handles the technical aspects of permission requesting, so this story focuses on creating a compelling UI that integrates into the onboarding flow.

## Detailed Requirements

- Implement the "Notification Permissions" screen.
- UI Elements:
  - Informative title: "Stay on Track."
  - Explanation: "Allow notifications to receive helpful reminders for your scheduled routine sessions and celebrate your progress."
  - Buttons: "Enable Notifications" (triggers native iOS prompt) and "Maybe Later."
- Display this screen after routine selection (if applicable) or before navigating to the main app.

## Acceptance Criteria (ACs)

- AC1: The Notification Permissions screen is displayed with its specified UI elements.
- AC2: The explanation clearly states the value of notifications in the app's context.
- AC3: Tapping "Enable Notifications" correctly triggers the native iOS permission prompt.
- AC4: User can choose "Maybe Later" and proceed to the main app.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards and understand the project structure. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Create: 
    - `Growth/Features/Onboarding/Views/NotificationPermissionsView.swift`
  - Files to Modify: 
    - `Growth/Features/Onboarding/Views/OnboardingFlowCoordinator.swift` (add new step case)
    - `Growth/Features/Onboarding/ViewModels/OnboardingViewModel.swift` (add notifications step in enum)

- **Key Technologies:**

  - SwiftUI for UI implementation
  - UserNotifications framework for permission handling
  - Existing NotificationsManager singleton for permission logic
  - Existing AppTheme colors and typography system

- **API Interactions / SDK Usage:**

  - NotificationsManager.shared.requestPermissions() - existing method to trigger iOS permission dialog
  - NotificationsManager.shared.isAuthorized - published property to check current authorization status
  - UNUserNotificationCenter for underlying permission handling (already wrapped by NotificationsManager)

- **UI/UX Notes:**

  - Follow app's design principles: calm, professional, supportive
  - Use existing color scheme from AppTheme.Colors:
    - Primary button: "GrowthGreen" for "Enable Notifications"
    - Secondary option: text button style for "Maybe Later"
    - Background: "GrowthBackgroundLight"
  - Typography should use AppTheme.Typography styles
  - Include a relevant icon (bell or notification symbol)
  - Center-aligned content with proper spacing
  - Button styling should follow existing PrimaryButtonStyle and text button patterns
  - Include subtle animation when screen appears

- **Data Structures:**

  - No new data structures needed - permission status is handled by iOS and NotificationsManager
  - Note: The user's notification preference choice could be logged for analytics (future enhancement)

- **Environment Variables:**

  - None specific to this story

- **Coding Standards Notes:**
  - Follow SwiftUI best practices for view composition
  - Use @ObservedObject for OnboardingViewModel
  - Leverage existing UI components and styles where possible
  - Handle the async nature of permission requests appropriately

## Tasks / Subtasks

- [x] Add notificationPermissions case to OnboardingStep enum after routineGoalSelection
- [x] Create NotificationPermissionsView.swift with the specified UI
  - [x] Implement the informative title and explanation text
  - [x] Add bell/notification icon for visual context
  - [x] Create "Enable Notifications" primary button
  - [x] Create "Maybe Later" text button
  - [x] Style according to app theme
- [x] Update OnboardingFlowCoordinator to include NotificationPermissionsView
  - [x] Add case for .notificationPermissions in the switch statement
  - [x] Ensure proper navigation flow
- [x] Implement permission request handling
  - [x] Connect "Enable Notifications" to NotificationsManager.shared.requestPermissions()
  - [x] Handle completion callback to advance onboarding
  - [x] Handle "Maybe Later" to skip and advance
- [x] Test permission flow on simulator and device
  - [x] Verify iOS permission dialog appears correctly
  - [x] Test both grant and deny scenarios
  - [x] Ensure "Maybe Later" properly skips

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:** 
  - Test OnboardingViewModel advancement through notifications step
  - Verify that notification permissions step appears in correct order
  - Test that both button actions advance the onboarding flow

- **Integration Tests:**
  - Test that NotificationsManager.requestPermissions is called when "Enable Notifications" is tapped
  - Verify proper integration with iOS notification permissions system
  - Test navigation flow from routine selection through notifications to completion

- **Manual/UI Verification:**
  - Verify the screen appears after routine selection
  - Test visual appearance matches design specifications
  - Verify iOS permission prompt appears when "Enable Notifications" is tapped
  - Test "Maybe Later" skips permissions and continues onboarding
  - Verify proper behavior on both first launch and subsequent launches
  - Test on physical device to ensure permission prompt works correctly

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** Claude Opus 4 (claude-opus-4-20250514)
- **Completion Notes:** 
  - Successfully implemented the notification permissions screen as the final substantive onboarding step
  - Created a calm, professional UI with clear value proposition for notifications
  - Integrated with existing NotificationsManager for permission handling
  - Added subtle animations for improved user experience
  - Both "Enable Notifications" and "Maybe Later" options advance the onboarding flow
  - Added comprehensive unit tests for the new onboarding step
  - The screen properly handles both grant and deny scenarios from iOS permission prompt
  
- **Change Log:** 
  - Initial implementation completed
  - Added notificationPermissions to OnboardingStep enum
  - Created NotificationPermissionsView with specified UI/UX
  - Updated OnboardingFlowCoordinator to include the new step
  - Added tests to verify proper flow progression