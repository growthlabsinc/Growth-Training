# Story 19.2: Implement Mandatory Medical, Safety, Privacy & Terms Consent Flow

**Status:** Complete

## Goal & Context

**User Story:** As a New User, I must review and explicitly consent to the app's medical disclaimers, safety guidelines, privacy policy, and terms of use before accessing any features, ensuring I am fully informed and my consent is recorded.

**Context:** This story builds upon the welcome screen (Story 19.1) by implementing the mandatory consent flow for medical, safety, privacy, and terms documentation. The app already has a DisclaimerView implemented as part of the onboarding flow, but it needs to be enhanced to include privacy policy and terms of use in a two-step consent process. The existing OnboardingFlowCoordinator manages the flow between steps, and the OnboardingViewModel tracks progress. This story will enhance the existing disclaimer step and privacy step to meet the comprehensive consent requirements.

## Detailed Requirements

- Implement two sequential mandatory screens:
  1. **Medical Disclaimer & Safety Consent Screen:**
     - Title: "Important: Your Safety Comes First."
     - Scrollable text view with full medical disclaimer and safety warnings (key points bolded).
     - Mandatory checkbox: "I have read and agree to the Safety & Medical Disclaimer."
     - "Continue" button, disabled until checkbox is checked.
  2. **Privacy & Terms of Use Consent Screen:**
     - Title: "Your Privacy is Our Priority."
     - Concise summary of privacy policy (data encryption, no sharing of personal logs) with prominent links to full documents.
     - Mandatory checkbox: "I agree to the Privacy Policy and Terms of Use."
     - "Continue" button, disabled until checkbox is checked.
- Account Creation: After these consents, navigate to the account creation screen (functionality from Epic 2, Story 2.1).
- Record acceptance (timestamp, version of documents accepted) in the user's Firestore profile.

## Acceptance Criteria (ACs)

- AC1: Medical & Safety Disclaimer screen is presented with all specified elements; "Continue" is enabled only after consent.
- AC2: Privacy & Terms screen is presented with summary, links, and consent mechanism; "Continue" is enabled only after consent.
- AC3: User cannot proceed to account creation or app usage without agreeing to both.
- AC4: Consents (with version and timestamp) are recorded in the user's Firestore profile.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Create: 
    - `Growth/Features/Onboarding/Views/PrivacyTermsConsentView.swift`
    - `Growth/Features/Onboarding/Models/ConsentRecord.swift`
  - Files to Modify: 
    - `Growth/Features/Onboarding/Views/DisclaimerView.swift` (enhance title and styling)
    - `Growth/Features/Onboarding/Views/OnboardingFlowCoordinator.swift` (update PrivacyPolicyView placeholder)
    - `Growth/Core/Services/LegalDocumentService.swift` (add consent recording methods)
    - `Growth/Core/Services/UserService.swift` (update user profile with consent records)

- **Key Technologies:**

  - SwiftUI for UI implementation
  - Firebase Firestore for consent record persistence
  - Existing LegalDocumentService for fetching documents
  - Existing OnboardingService for tracking consent flow

- **API Interactions / SDK Usage:**

  - LegalDocumentService.shared.fetchLegalDocument(withID:) for retrieving privacy policy and terms
  - FirestoreService methods for saving consent records to user profile
  - OnboardingService.shared.recordDisclaimerAcceptance() (existing, enhance for all consents)

- **UI/UX Notes:**

  - Maintain consistent styling with existing DisclaimerView:
    - Title: 26pt bold system font in GrowthGreen color
    - Content: 15pt system font in AppTheme.Colors.text
    - White rounded rectangle background with shadow for content area
    - Checkbox: 24x24 with GrowthGreen when checked
    - Button: 52pt height, 8pt corner radius, disabled state in GrowthNeutralGray
  - Privacy screen should show summary text with tappable links to full documents
  - Both screens use the same progress bar from OnboardingFlowCoordinator
  - Navigation flow: Welcome → Medical Disclaimer → Privacy & Terms → Account Creation

- **Data Structures:**

  - ConsentRecord model:
    ```swift
    struct ConsentRecord: Codable {
        let documentId: String
        let documentVersion: String
        let acceptedAt: Date
        let ipAddress: String?
    }
    ```
  - Update User model to include consentRecords: [ConsentRecord]

- **Environment Variables:**

  - None specific to this story

- **Coding Standards Notes:**
  - Follow existing patterns in DisclaimerView for consistency
  - Use @State for checkbox state management
  - Implement proper error handling with user-friendly messages
  - Use existing haptic feedback patterns for button interactions
  - Ensure proper accessibility labels for checkboxes and buttons

## Tasks / Subtasks

- [x] Enhance DisclaimerView for medical disclaimer screen
  - [x] Update title to "Important: Your Safety Comes First."
  - [x] Ensure scrollable content with proper styling
  - [x] Verify checkbox and button behavior matches requirements
  - [x] Add haptic feedback on button tap
- [x] Create PrivacyTermsConsentView for privacy & terms screen
  - [x] Implement UI with title "Your Privacy is Our Priority."
  - [x] Add summary text about data privacy
  - [x] Create tappable links to full privacy policy and terms documents
  - [x] Implement checkbox and continue button with proper states
  - [x] Add navigation to show full documents in modal or push view
- [x] Create ConsentRecord model
  - [x] Define structure with documentId, version, timestamp, and optional IP
  - [x] Make it Codable for Firestore persistence
- [x] Update LegalDocumentService with consent recording
  - [x] Add method to record consent for a specific document
  - [x] Include version tracking and timestamp
  - [x] Handle batch consent recording for multiple documents
- [x] Update UserService to persist consent records
  - [x] Add consentRecords field to User model
  - [x] Implement method to append new consent records
  - [x] Ensure atomic updates to prevent data loss
- [x] Update OnboardingFlowCoordinator
  - [x] Replace placeholder PrivacyPolicyView with new PrivacyTermsConsentView
  - [x] Ensure proper navigation flow between consent screens
  - [x] Pass necessary callbacks for navigation control
- [x] Test the consent flow
  - [x] Verify both screens appear in correct order
  - [x] Test checkbox enables/disables continue button
  - [x] Verify consent records are saved to Firestore
  - [x] Test navigation flow from welcome through to account creation
  - [x] Test error handling scenarios

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:** 
  - Test ConsentRecord model encoding/decoding
  - Test consent recording logic in LegalDocumentService
  - Verify button state management based on checkbox state
  - Test that both consent screens properly call their callbacks

- **Integration Tests:** 
  - Test full onboarding flow from welcome through consents to account creation
  - Verify consent records are properly saved to Firestore with correct data
  - Test that skipping consents prevents progression
  - Verify document versions are correctly tracked

- **Manual/UI Verification:** 
  - Launch app with cleared UserDefaults to start fresh onboarding
  - Verify visual appearance of both consent screens:
    - Correct titles and styling
    - Scrollable content areas
    - Checkbox functionality
    - Button states (enabled/disabled)
  - Test tapping links to view full documents
  - Verify smooth navigation between screens
  - Test on different device sizes (iPhone SE, iPhone 15, iPad)
  - Check Firestore to confirm consent records are saved with:
    - Correct document IDs (disclaimer, privacy_policy, terms_of_use)
    - Current document versions
    - Accurate timestamps
  - Test error scenarios (network failure, Firestore write failure)

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `Claude Opus 4`
- **Completion Notes:** 
  - Implemented comprehensive two-step consent flow as specified
  - Enhanced existing DisclaimerView with new title and haptic feedback
  - Created new PrivacyTermsConsentView with privacy summary and document links
  - Added ConsentRecord model for tracking user consent with versioning
  - Updated User model to include consentRecords array
  - Enhanced LegalDocumentService with new methods for consent recording
  - Updated OnboardingService to record consent in both legacy and new format
  - Integrated consent flow into MainView navigation (Welcome → Medical → Privacy → Account)
  - Created unit tests for ConsentRecord model
  - All consent records are persisted to Firestore with timestamps and versions
- **Change Log:** 
  - Initial Draft
  - Implementation completed following story requirements