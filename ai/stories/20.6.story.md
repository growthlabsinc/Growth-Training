# Story 20.6: Tour Step 5 - Introducing the AI "Coach"

**Status:** Review

## Goal & Context

**User Story:** As a New User on the app tour, I want to be introduced to the AI Coach, so I know I have a resource for questions.

**Context:** This story builds upon the app tour framework established in Story 20.1 and the previous tour steps from Stories 20.2-20.5. It implements the sixth and final step of the app tour, which introduces new users to the AI Coach feature. The AI Coach is currently accessed through the Learn tab, not a dedicated Coach tab as mentioned in the epic. This final step will highlight the Learn tab and explain how to access the AI Coach within it. The tour continues to use the coach mark/spotlight UI system already implemented, and leverages the manual tab frame calculation approach established in previous stories. Upon completion of this step, the app tour is marked as complete and will not appear again.

## Detailed Requirements

- The final step of the tour highlights the "Learn" tab in the bottom navigation bar (where the AI Coach is accessed).
- The popover text should explain: "Have questions? Our AI 'Coach' is here to help guide you based on the app's content and community insights. Tap the 'Learn' tab and select 'AI Coach' any time you need support."
- The final "Done" or "Get Started" button in the popover should dismiss the tour and complete it.

## Acceptance Criteria (ACs)

- AC1: The tour correctly highlights the "Learn" tab where the AI Coach is accessed.
- AC2: The popover text introduces the AI Coach and explains how to access it through the Learn tab.
- AC3: Tapping the final button in the popover successfully ends the tour and sets the flag so it won't appear again.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Create: 
    - None (tour steps configuration will be added to existing framework)
  
  - Files to Modify: 
    - `Growth/Features/AppTour/Models/AppTourStep.swift` - Add new tour step to defaultTour configuration and update progress step
    - `Growth/MainView.swift` - Update setupTabBarFramesForTour to calculate Coach tab frame  
    - `GrowthUITests/AppTourUITests.swift` - Update tests for coach tour step

- **Key Technologies:**

  - SwiftUI TabView and custom tab frame calculation
  - AppTourStep configuration model
  - Coach mark UI components already created
  - Manual frame calculation approach from Stories 20.3-20.5

- **API Interactions / SDK Usage:**

  - No new API interactions required
  - Uses existing AppTourService for state persistence
  - Tour completion flag is managed by AppTourViewModel

- **UI/UX Notes:**

  - The tour should highlight the entire Learn tab item in the bottom navigation bar
  - The popover should appear above the tab bar (using `.above` position)
  - Ensure the highlight properly encompasses the book icon and "Learn" label
  - The coach mark should dim the rest of the screen while keeping the Learn tab clearly visible
  - Learn tab is at index 4 (fifth tab) in the tab bar: Home(0), Routines(1), Practice(2), Progress(3), Learn(4)
  - The AI Coach is accessed within the Learn tab via the AI Coach selection card

- **Data Structures:**

  - Update the progress step (Story 20.5) to have `isLastStep: false` and `buttonTitle: "Next"`
  - Add new `AppTourStep` to the `defaultTour` configuration after the progress step:
    ```swift
    AppTourStep(
        id: "learn_tab",
        targetViewId: "learn_tab_item",
        title: "Have Questions?",
        description: "Have questions? Our AI 'Coach' is here to help guide you based on the app's content and community insights. Tap the 'Learn' tab and select 'AI Coach' any time you need support.",
        highlightPadding: 12,
        position: .above,
        buttonTitle: "Done",
        isLastStep: true
    )
    ```

- **Environment Variables:**

  - None required for this story

- **Coding Standards Notes:**
  - Follow existing pattern for tour step configuration
  - Maintain consistency with Stories 20.3-20.5's implementation approach  
  - Use the manual tab frame calculation pattern established previously
  - The Learn tab tour step should have `buttonTitle: "Done"` since it's the final step
  - Ensure AppTourViewModel.completeTour() is called when the final button is tapped

## Tasks / Subtasks

- [x] Update AppTourStep configuration
  - [x] Update the progress step to have `isLastStep: false` and `buttonTitle: "Next"`
  - [x] Add new learn tab tour step after the progress step
  - [x] Ensure proper step ordering with learn tab as step 6 of total steps
- [x] Update tab frame calculation in MainView
  - [x] Add frame calculation for Learn tab (index 4) in setupTabBarFramesForTour
  - [x] Use same calculation approach as previous tabs
  - [x] Update the tour view model with learn tab frame
- [x] Test tour step functionality
  - [x] Verify the Learn tab is properly highlighted
  - [x] Confirm popover appears in correct position above tab bar
  - [x] Test navigation from progress step to learn tab step
  - [x] Test "Done" button completes the tour and sets completion flag
- [x] Update UI tests
  - [x] Update step counters from "of 5" to "of 6"
  - [x] Extend existing tour test to include learn tab step
  - [x] Verify correct text content in popover
  - [x] Test that this is the final step in the sequence
  - [x] Test that tour completion flag is set after finishing

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:** 
  - Verify the new tour step is included in the default configuration
  - Test that step IDs remain unique across all tour steps
  - Confirm step count is updated correctly
  - Verify tour completion flag is set when final step is completed
  
- **UI Tests:** 
  - Extend `testRoutinesTabTourStep()` in `AppTourUITests.swift` to continue to learn tab step
  - Verify tour progresses from progress step to learn tab step
  - Test that tapping "Done" completes the tour and dismisses overlay
  - Verify step counter shows "Step 6 of 6"
  - Verify tour completion prevents future tour appearances
  - Test app behavior after tour completion
  
- **Manual/CLI Verification:** 
  - Complete onboarding flow and verify tour starts
  - Progress through all previous steps to reach learn tab step
  - Verify visual appearance: proper highlighting, popover position, text clarity
  - Test on different iPhone sizes to ensure popover positioning adapts correctly
  - Verify Learn tab (fifth tab) is correctly highlighted
  - Confirm tour does not reappear after completion
  - Verify the AI Coach can be accessed after tour by tapping Learn tab and selecting AI Coach

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** Claude 3 Opus (claude-opus-4-20250514)
- **Completion Notes:** 
  - Successfully implemented the Learn tab tour step as the sixth and final step in the app tour sequence
  - Added new AppTourStep configuration with title "Have Questions?" and appropriate description
  - Updated progress step to have `isLastStep: false` and "Next" button
  - Implemented manual frame calculation for Learn tab using same approach as previous tabs
  - Learn tab is at index 4 (fifth tab) in the tab bar
  - Extended UI tests to verify all six tour steps including the new learn tab step
  - The implementation follows the existing pattern from Stories 20.3-20.5
  - All syntax checks pass successfully
  - The AI Coach is accessed via the Learn tab rather than a dedicated Coach tab, which required slight adjustments to the original epic requirements
- **Change Log:** 
  - Initial Draft - 2025-01-09
  - Implementation Complete - 2025-01-09