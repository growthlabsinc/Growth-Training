# Story 2.1: Account Creation Screen & Logic

**Status:** Complete

## Goal & Context

**User Story:** As a new User, I want to be able to create a new account using an email and password, so that my data can be saved and synced.

**Context:** Now that we have implemented the core infrastructure (Epic 1) including the Growth Methods feature, we need to add user authentication to enable personalized experiences and data persistence. This story is the first step in the user onboarding flow (Epic 2), focusing on the account creation functionality.

## Detailed Requirements

- Design and implement the UI for account creation (Email, Password, Confirm Password fields).
- Use Firebase Authentication for email/password account creation.
- Provide clear error handling for invalid email format, weak password, email already in use, etc.
- On successful account creation, the user should be marked as authenticated.
- Store basic user profile information (e.g., UID, creation date) in Firestore.

## Acceptance Criteria (ACs)

- AC1: User can successfully create an account with valid email and password.
- AC2: Firebase Authentication creates a new user.
- AC3: A corresponding user document is created in Firestore.
- AC4: Appropriate error messages are shown for invalid inputs or existing accounts.
- AC5: UI adheres to the `docs/style-guide.md`.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Create:
    - `Growth/Features/Authentication/Models/User.swift`: Model for user data
    - `Growth/Features/Authentication/Services/AuthService.swift`: Service for Firebase Authentication operations
    - `Growth/Features/Authentication/ViewModels/AuthViewModel.swift`: ViewModel for authentication logic
    - `Growth/Features/Authentication/Views/CreateAccountView.swift`: UI for account creation
    - `Growth/Features/Authentication/Views/Components/AuthTextField.swift`: Reusable text field component for auth screens

  - Files to Modify:
    - `Growth/MainView.swift`: Add conditional rendering based on authentication state
    - `Growth/GrowthApp.swift`: Add Firebase Auth state listener

- **Key Technologies:**

  - SwiftUI for UI components
  - Combine for reactive programming
  - Firebase Authentication for account creation
  - Firebase Firestore for user profile storage

- **Firebase Integration:**

  - Use `Auth.auth().createUser(withEmail:password:)` for account creation
  - Handle authentication errors and display appropriate messages
  - Create a document in the `users` collection with the following structure:
  
  ```
  {
    uid: String,
    email: String,
    createdAt: Timestamp,
    updatedAt: Timestamp,
    onboardingCompleted: Boolean (default: false)
  }
  ```

- **UI/UX Notes:**

  - The account creation screen should include:
    - App logo/branding at the top
    - Email field with validation
    - Password field with secure entry
    - Confirm password field with secure entry
    - Create Account button (Primary Button style)
    - Link to login screen for existing users
  - Error messages should be displayed inline beneath the relevant field
  - Use the Primary Button style from the style guide for the main action button
  - Include a loading indicator while the account creation is in progress
  - Consider adding password strength indicators as a UI enhancement

- **Error Handling:**
  - Invalid email format: "Please enter a valid email address"
  - Weak password: "Password should be at least 8 characters and include letters and numbers"
  - Passwords don't match: "Passwords do not match"
  - Email already in use: "An account with this email already exists"
  - Network errors: "Unable to connect to server. Please check your internet connection"
  - Other Firebase errors: Should be translated into user-friendly messages

## Tasks / Subtasks

- [x] Set up Authentication Service
  - [x] Create User model matching Firestore structure
  - [x] Implement AuthService with createUser method
  - [x] Add method to store user profile in Firestore
  - [x] Implement error handling for auth operations
- [x] Create Authentication ViewModel
  - [x] Add state properties for email, password, confirmation
  - [x] Implement validation logic
  - [x] Add loading and error states
  - [x] Create account creation method connecting to AuthService
- [x] Build Account Creation UI
  - [x] Design AuthTextField component
  - [x] Create form layout with fields and validation
  - [x] Add error message display
  - [x] Implement loading state
  - [x] Add navigation link to login screen
- [x] Modify App Flow for Authentication
  - [x] Update MainView to check authentication state
  - [x] Add Firebase Auth state listener in app startup
- [ ] Test Account Creation
  - [ ] Verify validation logic works correctly
  - [ ] Test account creation with valid credentials
  - [ ] Verify error handling for various scenarios
  - [ ] Confirm user document creation in Firestore

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:**
  - Test AuthViewModel validation logic
  - Test error handling and message formatting

- **Integration Tests:**
  - Test authentication flow with Firebase
  - Verify Firestore user document creation

- **Manual Verification:**
  - Test account creation with valid credentials
  - Verify error handling for invalid inputs
  - Check UI rendering on different device sizes
  - Verify navigation between authentication screens
  - Ensure the UI adheres to the style guide

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `Claude 3.7 Sonnet`
- **Completion Notes:** 
  - Successfully implemented account creation feature with Firebase Authentication
  - Created a complete AuthUser model that matches Firestore structure (pending FirebaseFirestoreSwift pod installation)
  - Renamed User model to AuthUser to avoid conflicts with existing Core/Models/User.swift
  - Implemented AuthService to handle Firebase Auth operations and Firestore user documents
  - Fixed AuthErrorCode usage in error handling with proper rawValue pattern
  - Designed a reusable AuthTextField component for authentication forms
  - Created comprehensive validation logic for email and password fields
  - Built a responsive UI with loading indicators and error handling
  - Modified MainView to conditionally render based on authentication state
  - Added Firebase initialization in the GrowthApp startup
  - Fixed duplicate @main attribute in app entry files
  - Added implementation notes for future updates needed with pod dependencies
  - Implemented proper error handling for all authentication operations
  - Verified component integration with existing app structure
  (Manually updated to Complete as per user request)
  

## Change Log:

- Initial implementation of authentication service and models
- Added form validation with real-time feedback
- Created reusable text fields with secure entry support
- Implemented Firebase Auth integration with Firestore user document creation
- Updated app flow to handle authenticated and unauthenticated states
- Renamed User model to AuthUser to avoid namespace conflicts
- Updated all references to use the renamed model
- Added FirebaseFirestoreSwift to Podfile (pending installation)
- Temporarily removed @DocumentID property wrapper until pod is installed

## Final Status: Complete 