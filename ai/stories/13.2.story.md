# Story 13.2: Implement "Angio Pumping" Conditional Pre-Stage

**Status:** Draft

## Goal & Context

**User Story:** As a User who is unable to achieve an erection on my own, I want the app to guide me to "Angio Pumping" as my starting point before proceeding to the standard Beginner method.

**Context:** This story builds upon the recent reclassification of Growth Methods (Story 13.1) by implementing a conditional starting path for users with erectile dysfunction. According to the official documentation, some users need to begin with "Angio Pumping" to build sufficient vascular health before they can effectively perform Angion Method 1.0. This story adds a self-assessment question during onboarding to direct users to the appropriate starting method based on their specific physiological condition.

## Detailed Requirements

- Based on `docs/Untitled 5.txt`, "ANGIO PUMPING (E CLASS)" is for users with "non-compliant Erectile Dysfunction" who cannot achieve an erection unassisted. [cite: 189, 190]
- During user onboarding (after initial profile setup - Epic 2), or via a self-assessment quiz, ask the user if they can achieve an erection suitable for Angion Method 1.0 without aids.
- If the user indicates they cannot, their "Current Focused Stage" should be set to "Angio Pumping."
- Create a dedicated method entry in `growthMethods` for "Angio Pumping" including its specific technique (fluctuating pressure, ACE bandage, quick release pump [cite: 193, 196, 199, 200]), session times (initially short, up to 10 mins, aim for 30 mins [cite: 211, 212, 213]), and graduation criteria ("able to maintain an erection for at least 15 minutes without the use of devices or vaso-active substances" [cite: 215]).
- Users graduating from Angio Pumping should then be guided to ANGION METHOD 1.0 (Beginner).

## Acceptance Criteria (ACs)

- AC1: Users who self-identify as unable to achieve unassisted erections are directed to Angio Pumping as their starting method.
- AC2: Angio Pumping is detailed as a method in Firestore with its specific technique, session times, and graduation criteria from `docs/Untitled 5.txt`.
- AC3: Upon meeting Angio Pumping graduation criteria, the user is guided to start Angion Method 1.0.
- AC4: Users who can achieve unassisted erections bypass Angio Pumping and start with Angion Method 1.0 (Beginner) or as per their selection.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. The developer should understand how to modify the onboarding flow to include the self-assessment question and how to update the user's profile to track their recommended starting method.

- **Relevant Files:**

  - Files to Modify: 
    - `Growth/Core/Models/User.swift` - Update to store recommended starting method
    - `Growth/Features/Onboarding/ViewModels/OnboardingViewModel.swift` - Add self-assessment functionality
    - `Growth/Features/Onboarding/Views/OnboardingFlowCoordinator.swift` - Add self-assessment screen to the flow
    - `Growth/Core/Services/FirestoreService.swift` - Ensure method for saving user's recommended method
  - Files to Create:
    - `Growth/Features/Onboarding/Views/SelfAssessmentView.swift` - UI for erection capability question
    - `scripts/angio-pumping-migration.js` - Update script to add Angio Pumping method (if not already done in 13.1)

- **Key Technologies:**

  - SwiftUI for UI components
  - Combine framework for view model state management
  - Firebase Firestore for data persistence
  - Node.js with Firebase Admin SDK (for migration script, if needed)

- **API Interactions / SDK Usage:**

  - Firestore operations:
    - Update user document with recommended method field
    - Read/write to the `growthMethods` collection if needed
  - UserDefaults for local persistence during onboarding

- **Data Structures:**

  - Update `User` model to include a `recommendedStartingMethod` field (String)
  - Ensure the Angio Pumping method in Firestore includes all required fields:
    ```swift
    {
      id: "angio_pumping",
      title: "Angio Pumping",
      classification: "Prerequisite",
      stage: 0,
      methodDescription: "...",
      instructionsText: "...",
      progressionCriteriaText: "...",
      safetyNotes: "...",
      equipmentNeeded: ["Quick release pump", "ACE bandage", ...],
      estimatedDurationMinutes: 10  // Initial recommendation
    }
    ```

- **Coding Standards Notes:**
  - Follow existing UI patterns for consistency in the onboarding flow
  - Use clear, medically appropriate language in the self-assessment question
  - Error on the side of recommending Angio Pumping if the user is uncertain

## Tasks / Subtasks

- [ ] Update User model
  - [ ] Add field for tracking recommended starting method
  - [ ] Ensure Firestore serialization/deserialization handles the new field
- [ ] Create self-assessment UI
  - [ ] Design SelfAssessmentView with appropriate question and options
  - [ ] Create view model logic to process the user's response
  - [ ] Add clear, simple explanation of why this question is being asked
- [ ] Modify onboarding flow
  - [ ] Insert self-assessment step in OnboardingFlowCoordinator
  - [ ] Save assessment result to user's profile
  - [ ] Update OnboardingViewModel to track the new step
- [ ] Ensure Angio Pumping method exists in Firestore
  - [ ] Check if method-migration.js already includes Angio Pumping
  - [ ] If not, create angio-pumping-migration.js to add it
  - [ ] Run migration script to ensure method exists
- [ ] Implement method recommendation logic
  - [ ] Based on assessment, set user's recommended method
  - [ ] Store preference in Firestore

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

- **Unit Tests:** 
  - Test User model serialization/deserialization with the new field
  - Test OnboardingViewModel logic for handling self-assessment result

- **Integration Tests:** 
  - Verify the onboarding flow with the new self-assessment step
  - Test that user preferences are correctly saved to Firestore

- **Manual Verification:**
  - Test onboarding as a new user who cannot achieve unassisted erections
  - Verify they get directed to Angio Pumping
  - Test as a user who can achieve unassisted erections
  - Verify they get directed to AM 1.0 or their selection
  - Verify Angio Pumping method details are displayed correctly
  - Check progression criteria display for Angio Pumping

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:** {Track changes _within this specific story file_ if iterations occur}
  - Initial Draft
  - ... 