# Story 16.1: Develop Multi-Method Guided Practice Flow

**Status:** Review

## Goal & Context

**User Story:** As a User following a routine with multiple methods in a single day, I want a guided flow that automatically progresses me from one method to the next with clear transitions.

**Context:** This story builds upon the navigation infrastructure established in Story 15.4 (smart navigation transitions and context preservation) to implement the core multi-method guided practice experience. The app already has DailyRoutineView that displays multiple methods for a day, but currently lacks automatic progression between methods and clear visual indicators of progress through the session. This story focuses on creating a seamless flow that guides users through multi-method routine days.

## Detailed Requirements

- Implement the "Guided Practice Flow" for routine days that have multiple methods.
- When a method within a multi-method session is completed (timer ends), automatically transition to the next scheduled method.
- Display context-aware navigation controls (e.g., "Next Method," "Previous Method" if applicable, current position like "Method 1 of 3").
- Show an "Up Next" preview or a method queue visualization during practice to inform the user about what's coming in the current session.
- Display total estimated session time remaining for the entire multi-method block.

## Acceptance Criteria (ACs)

- AC1: Users are automatically guided from one method to the next in a multi-method routine day.
- AC2: "Up Next" previews and overall session progress (e.g., "Method X of Y," total time remaining) are displayed.
- AC3: Contextual navigation controls for multi-method sessions are functional.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards and understand the project structure. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Create: 
    - `Growth/Features/Routines/ViewModels/MultiMethodSessionViewModel.swift`
    - `Growth/Features/Routines/Views/Components/MethodProgressIndicator.swift`
    - `Growth/Features/Routines/Views/Components/UpNextPreview.swift`
  - Files to Modify: 
    - `Growth/Features/Routines/Views/DailyRoutineView.swift`
    - `Growth/Features/Routines/ViewModels/DailyRoutineViewModel.swift`
    - `Growth/Features/Timer/Views/TimerView.swift`
    - `Growth/Features/Timer/ViewModels/TimerViewModel.swift`
    - `Growth/Core/Navigation/NavigationContext.swift`

- **Key Technologies:**

  - SwiftUI NavigationStack for managing navigation flow
  - Combine framework for reactive state management
  - Timer integration with automatic method progression
  - @StateObject and @EnvironmentObject for state management

- **API Interactions / SDK Usage:**

  - Existing GrowthMethodService for fetching method details
  - NavigationContext (from Story 15.4) for maintaining session state
  - SmartNavigationService (from Story 15.4) for intelligent transitions

- **UI/UX Notes:** 

  - Follow established design patterns from existing timer and routine views
  - Use Color("GrowthGreen") for primary actions and progress indicators
  - Implement smooth transitions between methods using SwiftUI animations
  - Ensure breadcrumb navigation (from Story 15.4) remains visible throughout

- **Data Structures:**

  - Leverage existing DaySchedule model which contains methodIds array
  - Use GrowthMethod model for method details
  - Extend NavigationContext to track multi-method session state

- **Environment Variables:**

  - None specific to this story

- **Coding Standards Notes:**
  - Follow SwiftUI best practices for state management
  - Use AppTheme.Typography for consistent text styling
  - Implement proper loading states and error handling
  - Ensure all UI elements support Dynamic Type

## Tasks / Subtasks

- [x] Create MultiMethodSessionViewModel to manage multi-method flow state
  - [x] Track current method index and total methods
  - [x] Calculate total session time and remaining time
  - [x] Handle method completion and auto-progression logic
- [x] Implement MethodProgressIndicator component
  - [x] Display "Method X of Y" with visual progress
  - [x] Show total time remaining for session
  - [x] Integrate with NavigationContext for breadcrumb updates
- [x] Create UpNextPreview component
  - [x] Show next method name and duration
  - [x] Display during last 30 seconds of current method
  - [x] Add smooth animation for appearance/disappearance
- [x] Update DailyRoutineView for multi-method flow
  - [x] Replace individual method timers with unified session flow
  - [x] Add navigation controls (Next/Previous Method)
  - [x] Handle automatic progression on method completion
- [x] Enhance TimerView for multi-method context
  - [x] Display method progress indicator
  - [x] Show up-next preview when appropriate
  - [x] Handle transitions between methods seamlessly
- [x] Update NavigationContext for session tracking
  - [x] Add properties for tracking multi-method sessions
  - [x] Update breadcrumb text generation for method transitions
- [x] Add haptic feedback for method transitions
  - [x] Use UIImpactFeedbackGenerator for method completion
  - [x] Provide subtle feedback on navigation actions

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach.

- **Unit Tests:** 
  - Test MultiMethodSessionViewModel state management and progression logic
  - Verify time calculations for total session and remaining time
  - Test auto-progression triggers and navigation state updates
- **Integration Tests:** 
  - Test flow from DailyRoutineView through multiple TimerView instances
  - Verify NavigationContext updates correctly throughout session
  - Test interruption and resume scenarios
- **Manual/CLI Verification:** 
  - Create a test routine with 3 methods and verify smooth progression
  - Test early exit scenarios and partial session completion
  - Verify UI updates correctly reflect current position in session

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** Claude Opus 4 (claude-opus-4-20250514)
- **Completion Notes:** 
  - Successfully implemented multi-method guided practice flow with automatic progression
  - Created reusable components for method progress tracking and up-next previews
  - Integrated with existing navigation context from Story 15.4
  - Added visual indicators for current method in the method list
  - Implemented haptic feedback for method transitions
  - The timer now properly tracks time and notifies the session view model
  - Auto-progression occurs after a 1-second delay when a method completes
  - Session completion UI is shown when all methods are done
- **Change Log:** 
  - Initial Draft - Created story based on Epic 16 requirements
  - Implementation completed - All ACs met with comprehensive multi-method flow