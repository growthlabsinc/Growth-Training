# Story 1.2: Firebase Firestore Setup & Basic Data Models

**Status:** Complete

## Goal & Context

**User Story:** As a Backend Developer, I want initial Firestore database rules and data models for User, GrowthMethod, SessionLog, and EducationalResource defined, so that app features can store and retrieve data securely.

**Context:** This story builds upon the project setup (Story 1.1) by defining the data models and security rules for Firebase Firestore. Now that the basic app structure and Firebase integration are in place, we need to establish the core data models that will be used throughout the application for storing user information, growth methods, session logs, and educational resources.

## Detailed Requirements

- Define Firestore data structure for:
  - `users`: (userId, creationDate, lastLogin, linkedProgressData, settings)
  - `growthMethods`: (methodId, stage, title, description, instructions_text, visual_placeholder_url, equipment_needed, progression_criteria, safety_notes)
  - `sessionLogs`: (logId, userId, methodId, startTime, duration, userNotes, moodBefore, moodAfter - structure for privacy)
  - `educationalResources`: (resourceId, title, content_text, category, visual_placeholder_url)
- Implement basic Firestore security rules:
  - Users can only read/write their own `sessionLogs` and `user` settings.
  - `growthMethods` and `educationalResources` are read-only for authenticated users.
  - Default deny all other access.
- Seed Firestore with sample data for `growthMethods` (at least 2-3 methods across different stages) and `educationalResources` (1-2 articles) for development.

## Acceptance Criteria (ACs)

- AC1: Firestore data models are documented (e.g., in `docs/data-models.md`).
- AC2: Basic Firestore security rules are implemented and tested via Firestore emulator or unit tests.
- AC3: Sample data is successfully seeded into Firestore and can be read by a test client.
- AC4: Data structures consider privacy needs (e.g., not storing overly sensitive free-text directly if it can be categorized).

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Create:
    - `docs/data-models.md`: Documentation of data models based on template
    - `Growth/Core/Models/User.swift`: Swift model for User data
    - `Growth/Core/Models/GrowthMethod.swift`: Swift model for GrowthMethod data
    - `Growth/Core/Models/SessionLog.swift`: Swift model for SessionLog data
    - `Growth/Core/Models/EducationalResource.swift`: Swift model for EducationalResource data
    - `Growth/Core/Services/FirestoreService.swift`: Service for interacting with Firestore
    - `firebase/firestore.rules`: Firestore security rules
    - `scripts/seed-firestore-data.js`: Script for seeding initial data
    - `data/sample-methods.json`: Sample growth methods for seeding
    - `data/sample-resources.json`: Sample educational resources for seeding

  - Files to Modify:
    - `Growth/Core/Networking/FirebaseClient.swift`: Extend to support Firestore operations
    - `GrowthTests/FirebaseClientTests.swift`: Add tests for new Firestore functionality

- **Key Technologies:**

  - Firebase Firestore
  - Firebase Authentication (for security rules)
  - Swift Codable for model serialization/deserialization
  - Node.js for data seeding scripts

- **API Interactions / SDK Usage:**

  - Firestore API:
    - Collection references: `.collection("users")`, `.collection("growthMethods")`, etc.
    - Document operations: `.document().setData()`, `.getDocument()`, `.addDocument()`
    - Query operations: `.whereField()`, `.order()`, `.limit()`
  - Codable protocol for Swift model serialization/deserialization
  - Firebase Security Rules language

- **Data Structures:**

  - User Model:
    ```swift
    struct User {
        let userId: String
        let creationDate: Date
        let lastLogin: Date
        let linkedProgressData: [String: Any]?
        let settings: UserSettings
    }
    
    struct UserSettings {
        let notificationsEnabled: Bool
        let reminderTime: Date?
        let privacyLevel: PrivacyLevel
        // Other user preferences
    }
    
    enum PrivacyLevel: String {
        case high, medium, low
    }
    ```

  - GrowthMethod Model:
    ```swift
    struct GrowthMethod {
        let methodId: String
        let stage: Int
        let title: String
        let description: String
        let instructionsText: String
        let visualPlaceholderUrl: String?
        let equipmentNeeded: [String]
        let progressionCriteria: String
        let safetyNotes: String
    }
    ```

  - SessionLog Model:
    ```swift
    struct SessionLog {
        let logId: String
        let userId: String
        let methodId: String
        let startTime: Date
        let duration: TimeInterval
        let userNotes: String?
        let moodBefore: Mood
        let moodAfter: Mood
    }
    
    enum Mood: String, Codable {
        case veryNegative, negative, neutral, positive, veryPositive
    }
    ```

  - EducationalResource Model:
    ```swift
    struct EducationalResource {
        let resourceId: String
        let title: String
        let contentText: String
        let category: ResourceCategory
        let visualPlaceholderUrl: String?
    }
    
    enum ResourceCategory: String, Codable {
        case basics, technique, science, safety, progression
    }
    ```

- **Environment Variables:**

  - No additional environment variables needed beyond what was set up in Story 1.1

- **Coding Standards Notes:**
  - Follow Swift standard naming conventions
  - Use Codable protocol for all models that will be stored in Firestore
  - Implement proper error handling for Firestore operations
  - Use strong typing for all model properties

## Tasks / Subtasks

- [x] Create Swift models for core data entities
  - [x] Implement User model with settings
  - [x] Implement GrowthMethod model
  - [x] Implement SessionLog model
  - [x] Implement EducationalResource model
  - [x] Ensure all models conform to Codable protocol
- [x] Create FirestoreService class
  - [x] Implement CRUD operations for each model
  - [x] Add error handling for Firestore operations
  - [x] Implement query methods for common use cases
- [x] Document data models in docs/data-models.md
  - [x] Document User model
  - [x] Document GrowthMethod model
  - [x] Document SessionLog model
  - [x] Document EducationalResource model
  - [x] Include privacy considerations
- [x] Create Firestore security rules
  - [x] Implement rules for user data
  - [x] Implement rules for growth methods
  - [x] Implement rules for session logs
  - [x] Implement rules for educational resources
- [x] Create sample data files
  - [x] Create sample growth methods
  - [x] Create sample educational resources
- [x] Implement data seeding script
  - [x] Add functionality to seed growth methods
  - [x] Add functionality to seed educational resources
- [x] Add unit tests
  - [x] Test model serialization/deserialization
  - [x] Test Firestore service CRUD operations
  - [x] Test security rules
- [x] Test functionality in the app
  - [x] Verify reading sample data
  - [x] Verify security rules working correctly

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:**
  - Test model serialization/deserialization to ensure Codable conformance
  - Test CRUD operations for each model via Firestore service
  - Test query methods for common use cases

- **Integration Tests:**
  - Test security rules using Firebase emulator
  - Test data seeding script against emulator or development environment

- **Manual Verification:**
  - Verify sample data is correctly loaded in the app
  - Test security rules with various user scenarios
  - Ensure all data models can be properly displayed in the app

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `Claude 3.7 Sonnet`
- **Completion Notes:** All tasks have been successfully completed. The Swift models for User, GrowthMethod, SessionLog, and EducationalResource have been implemented with proper Firestore compatibility, including Codable conformance and conversion methods. FirestoreService class has been created with CRUD operations and query methods for all models. Firestore security rules have been implemented based on the requirements, allowing users to only access their own data while keeping methods and resources read-only. Sample data and a seeding script have been created for growth methods and educational resources. All documentation has been added to data-models.md with proper security and privacy considerations detailed.
  (Manually updated to Complete as per user request)

- **Change Log:**
  - Initial Draft 
  - Implemented Swift models for all entities
  - Created FirestoreService class
  - Added Firestore security rules
  - Created sample data and seeding script
  - Added data model documentation 
  - Status updated to Complete by user request.

## Final Status: Complete 