# Story 19.4: Implement Onboarding Routine & Goal Selection Screen

**Status:** Complete

## Goal & Context

**User Story:** As a New User, I want to choose whether to start with a guided routine or opt for ad-hoc practice, so I can align the app with my preferences from the outset.

**Context:** This story builds upon the initial assessment (Story 19.3) by implementing the routine and goal selection screen. After the user's starting method has been determined (either "Angio Pumping" or "Angion Method 1.0"), they need to decide whether to follow a structured routine or practice ad-hoc. This is a critical decision point that shapes their entire app experience. The OnboardingFlowCoordinator will present this as a new step after the initial assessment, and the user's selection will be stored in their profile preferences.

## Detailed Requirements

- Implement the "Routine & Goal Selection" screen.
- UI Elements:
  - Encouraging title: "Choose Your Path."
  - Two primary options presented as visually appealing cards:
    - "Start a Guided Routine" (subtitle: "Follow a structured weekly program for consistent progress"). This should be the recommended option.
    - "I prefer Quick Practice" (subtitle: "Practice any method, any time, at your own pace").
  - A less prominent "Skip for now" text link.
- Logic:
  - If "Guided Routine" is selected, navigate to a simplified routine browser (initially showing Beginner routines, from Epic 15 Story 15.3).
  - If "Quick Practice" or "Skip for now" is selected, set user preference to ad-hoc practice.

## Acceptance Criteria (ACs)

- AC1: The Routine & Goal Selection screen is displayed with its specified UI elements.
- AC2: The "Start a Guided Routine" option is visually recommended.
- AC3: Selecting "Guided Routine" leads to a routine selection/Browse flow.
- AC4: Selecting "Quick Practice" or "Skip for now" sets the user's preference accordingly and proceeds to the next step.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards and understand the project structure. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Create: 
    - `Growth/Features/Onboarding/Views/RoutineGoalSelectionView.swift`
  - Files to Modify: 
    - `Growth/Features/Onboarding/Views/OnboardingFlowCoordinator.swift` (add new step case)
    - `Growth/Features/Onboarding/ViewModels/OnboardingViewModel.swift` (add new step in enum)
    - `Growth/Core/Models/User.swift` (ensure preferredPracticeMode field exists)
    - `Growth/Core/Services/UserService.swift` (update method to save practice preference)

- **Key Technologies:**

  - SwiftUI for UI implementation
  - Combine for reactive updates
  - Firebase Firestore for persisting user preferences

- **API Interactions / SDK Usage:**

  - UserService.shared.updateUserProfile() to save practice preference
  - Navigate to existing RoutinesListView for routine selection
  - Use OnboardingViewModel's advance() method for flow progression

- **UI/UX Notes:**

  - Follow app's design system: Core Green (#4CAF50), Pale Green for highlights
  - Cards should use CardView component with subtle shadows and 16pt padding
  - "Start a Guided Routine" card should have a recommended badge or visual indicator
  - Typography: Use .title2 for main title, .headline for card titles, .subheadline for subtitles
  - Cards should have tap feedback using ScaleButtonStyle
  - "Skip for now" should be a tertiary text button with reduced opacity (0.7)

- **Data Structures:**

  - User model should have `preferredPracticeMode: String?` field with values: "routine" | "adhoc"
  - Store selection timestamp for analytics: `practicePreferenceSetAt: Date?`

- **Environment Variables:**

  - None specific to this story

- **Coding Standards Notes:**
  - Follow SwiftUI best practices with @State for local UI state
  - Use environment objects for shared state (OnboardingViewModel)
  - Ensure proper error handling for database operations
  - Follow app's color naming convention using asset catalog colors

## Tasks / Subtasks

- [x] Add routineGoalSelection case to OnboardingStep enum in OnboardingViewModel
- [x] Create RoutineGoalSelectionView with specified UI layout
  - [x] Implement card-based selection UI with proper styling
  - [x] Add tap handlers for each option
  - [x] Implement "Skip for now" as a text button
- [x] Update OnboardingFlowCoordinator to handle the new step
- [x] Implement navigation logic:
  - [x] Navigate to routine browser if "Guided Routine" selected
  - [x] Save preference and advance if "Quick Practice" or "Skip" selected
- [x] Update User model and UserService to persist practice preference
- [x] Add appropriate haptic feedback for selections
- [x] Test all three selection paths thoroughly

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

- **Unit Tests:** 
  - Test that selecting each option updates the user's preferredPracticeMode correctly
  - Verify navigation logic for each selection path
  - Test that "Skip for now" behaves identically to "Quick Practice"

- **Integration Tests:**
  - Verify the screen appears in the correct order in the onboarding flow
  - Test that user preferences are properly saved to Firestore
  - Ensure navigation to routine browser works when selected

- **Manual/CLI Verification:**
  - Visual verification that "Start a Guided Routine" appears recommended
  - Test the complete flow from initial assessment through routine selection
  - Verify that skipping properly advances to the next onboarding step
  - Check that haptic feedback works on real device

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** Claude Opus 4 (claude-opus-4-20250514)
- **Completion Notes:** 
  - Successfully implemented the Routine & Goal Selection screen with all required UI elements
  - Added `preferredPracticeMode` and `practicePreferenceSetAt` fields to User model
  - Created `updatePracticePreference` method in UserService to persist user selection
  - Implemented proper navigation: guided routine leads to RoutinesListView, while quick practice/skip advances onboarding
  - Added haptic feedback for all user interactions
  - Created comprehensive unit tests for the new functionality
  - The "Start a Guided Routine" option is visually recommended with a "RECOMMENDED" badge
  - All three selection paths (Guided Routine, Quick Practice, Skip) save the preference correctly
  
- **Change Log:** 
  - Initial implementation completed
  - Added new onboarding step enum case
  - Created RoutineGoalSelectionView with card-based UI
  - Updated User model with practice preference fields
  - Added UserService method for updating practice preferences
  - Created unit tests for validation