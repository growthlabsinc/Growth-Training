# Story 23.1: Define Subscription Tiers and App Store Connect Configuration

**Status:** Draft

## Goal & Context

**User Story:** As a Product Owner, I want to define subscription tier pricing and configure App Store Connect products, so that we can prepare for subscription monetization infrastructure.

**Context:** This story initiates Epic 23 by establishing the foundational subscription tiers and App Store Connect product configuration that will be referenced throughout the entire subscription infrastructure implementation. This story defines the pricing strategy, subscription durations, and App Store Connect product IDs that subsequent stories will integrate into the iOS app using StoreKit 2, payment processing, and subscription management systems.

## Detailed Requirements

- Define 3 subscription tiers: Basic ($4.99/month), Premium ($9.99/month), Elite ($19.99/month)
- Each tier includes annual options with 2-month discount (Basic: $49.99/year, Premium: $99.99/year, Elite: $199.99/year)
- Configure App Store Connect subscription products with proper product IDs, localizations, and metadata
- Set up subscription groups in App Store Connect for upgrade/downgrade functionality
- Define feature access matrix for each subscription tier
- Create subscription product configuration data structure for iOS app integration
- Establish subscription tier validation and entitlement checking framework

## Acceptance Criteria (ACs)

- AC1: Three subscription tiers are defined with clear pricing, features, and duration options
- AC2: App Store Connect is configured with subscription products, groups, and metadata
- AC3: Product IDs and configuration data are documented for iOS integration
- AC4: Feature access matrix clearly defines what each tier includes/excludes
- AC5: Subscription validation framework is designed for StoreKit 2 integration

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Create: 
    - `Growth/Core/Models/SubscriptionTier.swift` - Core subscription tier data model
    - `Growth/Core/Models/SubscriptionProduct.swift` - App Store product configuration model
    - `Growth/Core/Services/SubscriptionEntitlementService.swift` - Subscription validation and entitlement checking
    - `docs/subscription-tiers-specification.md` - Complete tier specifications and App Store Connect configuration
  
  - Files to Modify: 
    - `Growth/Core/Models/User.swift` - Add subscription tier field and entitlements
    - `Growth/Features/Settings/Views/SettingsView.swift` - Add subscription management entry point

- **Key Technologies:**

  - StoreKit 2 framework for iOS subscription management
  - App Store Connect subscription product configuration
  - Swift Codable for subscription data models
  - Firebase Firestore for subscription status persistence
  - UserDefaults for local subscription cache

- **API Interactions / SDK Usage:**

  - App Store Connect APIs for subscription product management
  - StoreKit 2 APIs for product fetching and purchase validation
  - Firebase Functions for server-side subscription validation
  - App Store Server Notifications for subscription status updates

- **UI/UX Notes:**

  - Subscription tiers will be presented in a paywall interface (Story 23.2)
  - Settings view needs subscription management section
  - Feature access should gracefully handle tier restrictions
  - Clear upgrade/downgrade flow messaging

- **Data Structures:**

  - `SubscriptionTier` enum: `.basic`, `.premium`, `.elite`, `.none`
  - `SubscriptionProduct` struct with App Store Connect product IDs
  - `SubscriptionEntitlement` struct for feature access validation
  - User model extension with `currentSubscriptionTier` and `subscriptionExpirationDate`

- **Environment Variables:**

  - App Store Connect API credentials (for server-side validation)
  - Subscription shared secret for receipt validation
  - Firebase configuration for subscription data persistence

- **Coding Standards Notes:**
  - Follow existing Service pattern for `SubscriptionEntitlementService`
  - Use Swift enums for subscription tiers and entitlements
  - Implement proper error handling for subscription failures
  - Cache subscription status locally with server validation fallback

## Tasks / Subtasks

- [ ] Define subscription tier specifications
  - [ ] Create Basic tier: $4.99/month, $49.99/year with core features
  - [ ] Create Premium tier: $9.99/month, $99.99/year with advanced features
  - [ ] Create Elite tier: $19.99/month, $199.99/year with all features
  - [ ] Document feature access matrix for each tier
- [ ] Configure App Store Connect subscription products
  - [ ] Create subscription group for upgrade/downgrade functionality
  - [ ] Configure 6 products (3 tiers Ã— 2 durations) with proper metadata
  - [ ] Set up localizations for subscription descriptions
  - [ ] Document product IDs for iOS integration
- [ ] Implement core subscription data models
  - [ ] Create `SubscriptionTier.swift` enum with tier definitions
  - [ ] Create `SubscriptionProduct.swift` model with App Store configuration
  - [ ] Create `SubscriptionEntitlement.swift` for feature access validation
  - [ ] Extend User model with subscription fields
- [ ] Implement subscription entitlement service
  - [ ] Create `SubscriptionEntitlementService` with tier validation
  - [ ] Implement feature access checking methods
  - [ ] Add subscription status caching and refresh logic
  - [ ] Integrate with existing UserService for subscription data persistence
- [ ] Update Settings UI for subscription management
  - [ ] Add subscription status display in SettingsView
  - [ ] Create entry point for subscription management (future stories)
  - [ ] Implement subscription tier badge/indicator components

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:** 
  - Test `SubscriptionTier` enum values and feature mappings
  - Test `SubscriptionEntitlementService` validation logic
  - Test User model subscription field serialization
  - Verify product ID constants match App Store Connect configuration
  
- **Integration Tests:** 
  - Test subscription tier persistence to Firebase
  - Verify entitlement checking with various subscription states
  - Test subscription status caching and refresh cycles
  
- **Manual/CLI Verification:** 
  - Verify App Store Connect subscription products are properly configured
  - Test subscription tier feature access matrix documentation
  - Confirm product IDs are correctly documented for iOS integration
  - Validate subscription group configuration for upgrade/downgrade paths

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:** {Track changes _within this specific story file_ if iterations occur}
  - Initial Draft - 2025-01-04