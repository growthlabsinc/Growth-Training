# Story 9.3: Method Stage Progression Implementation

## Goal & Context

**User Story:** As a User, I want to progress to the next stage of a Growth Method when I'm ready, so I can continue advancing my personal growth journey at my own pace.

**Context:** This story builds directly on Stories 9.1 and 9.2, which implemented structured progression criteria and readiness assessment. Now that we can determine when a user is ready to progress, we need to implement the actual progression mechanism to allow users to advance to the next stage of a Growth Method. This completes the core progression flow in Epic 9.

## Detailed Requirements

- Implement a mechanism for users to progress to the next stage of a Growth Method once they're deemed ready
- Create a user-friendly UI to present the progression opportunity when appropriate
- Design a celebration/acknowledgment experience when a user advances to a new stage
- Add progression history tracking to maintain a record of user advancement
- Ensure stage progression is recorded correctly in analytics
- Update relevant views to reflect the new stage after progression

## Acceptance Criteria (ACs)

- AC1: Users who meet readiness criteria see a clear "Progress to Next Stage" option in the Method Detail view
- AC2: When a user progresses to a new stage, their user record is updated to reflect this advancement
- AC3: After progression, the user sees a congratulatory message and information about the new stage
- AC4: Method Detail view updates to show the new stage's content and requirements
- AC5: Dashboard updates to reflect the user's new stage for the method
- AC6: A progression event is logged to analytics when a user advances to a new stage
- AC7: User can view their progression history in their profile or method history

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards and understand the project structure. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Create: 
    - `Growth/Core/Models/ProgressionEvent.swift` - Model for tracking progression history
    - `Growth/Features/GrowthMethods/Views/StageProgressionView.swift` - UI component for progression
    
  - Files to Modify:
    - `Growth/Core/Services/ProgressionService.swift` - Add progression functionality
    - `Growth/Features/GrowthMethods/Views/GrowthMethodDetailView.swift` - Add progression UI
    - `Growth/Features/GrowthMethods/ViewModels/GrowthMethodDetailViewModel.swift` - Add progression logic
    - `Growth/Core/Services/FirestoreService.swift` - Add methods for progression history
    - `Growth/Core/Services/AnalyticsService.swift` - Add progression event tracking

- **Key Technologies:**

  - Swift & SwiftUI
  - Combine for reactive updates
  - Firebase/Firestore for user data and progression history
  - Firebase Analytics for event tracking

- **API Interactions / SDK Usage:**

  - Firestore transactions to update user's method stage
  - Firestore writes to record progression history
  - Firebase Analytics for tracking progression events

- **Data Structures:**

  - New `ProgressionEvent` model:
    ```swift
    struct ProgressionEvent: Codable, Identifiable {
        let id: String?
        let userId: String
        let methodId: String
        let fromStage: Int
        let toStage: Int
        let timestamp: Date
        let criteria: ProgressionCriteria?  // Criteria that were met
        var note: String?  // Optional user reflection on progression
    }
    ```
  
  - Modified UserProgressData to track current stage for each method:
    ```swift
    // Existing structure to be extended
    struct UserProgressData {
        // ... existing fields
        var methodStages: [String: Int]  // [methodId: currentStage]
    }
    ```

- **Environment Variables:**
  
  - No new environment variables needed

## Tasks / Subtasks

- [ ] Create `ProgressionEvent` model
  - [ ] Define struct with Codable, Identifiable conformance
  - [ ] Add Firestore serialization/deserialization support
  - [ ] Create appropriate initializers and helper methods

- [ ] Extend `ProgressionService` with progression functionality
  - [ ] Add method to progress user to next stage
  - [ ] Create function to record progression history
  - [ ] Implement validation to prevent inappropriate progression
  - [ ] Add lookup function for user's progression history

- [ ] Create `StageProgressionView` component
  - [ ] Design congratulatory UI for stage progression
  - [ ] Add animations/effects for celebration
  - [ ] Include information about new stage requirements
  - [ ] Add optional reflection input for user notes on progression

- [ ] Update `GrowthMethodDetailViewModel`
  - [ ] Add methods to handle progression request
  - [ ] Implement reactive updates after progression
  - [ ] Add error handling for progression failures

- [ ] Update `GrowthMethodDetailView`
  - [ ] Add progression button when user is ready
  - [ ] Implement progression flow UI
  - [ ] Add presentation of StageProgressionView after successful progression
  - [ ] Update UI to reflect new stage after progression

- [ ] Update `FirestoreService`
  - [ ] Add methods to store and retrieve progression history
  - [ ] Implement transaction for updating user's method stage

- [ ] Update `AnalyticsService`
  - [ ] Add tracking for stage progression events
  - [ ] Include relevant properties (method, from/to stage, etc.)

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

- **Unit Tests:** 
  - Test progression logic with various scenarios
  - Verify correct Firestore transactions for updating user stage
  - Test serialization/deserialization of ProgressionEvent model
  
- **Manual Verification:**
  - Complete method requirements and verify readiness assessment
  - Progress to next stage and verify all records are updated correctly
  - Check that UI updates appropriately after progression
  - Verify analytics events are logged correctly

## Implementation Notes

The stage progression feature should be designed as a rewarding experience that acknowledges the user's achievement while clearly communicating what's next. Consider these implementation details:

1. **User Experience Flow:**
   - When ready, show "Progress to Next Stage" button with subtle animation in GrowthMethodDetailView
   - On tap, show a confirmation dialog explaining the advancement
   - After confirmation, perform the progression and show celebration screen
   - Allow returning to the method detail view showing new stage

2. **Data Integrity:**
   - Use Firestore transactions to ensure atomicity when updating user's stage
   - Store progression history as a separate collection for future reference
   - Ensure progression is idempotent to prevent accidental double-progressions

3. **Progression Content:**
   - Leverage the `AffirmationService` from Story 8.5 to provide meaningful congratulatory messages
   - Include helpful tips or guidance for the new stage
   - Consider personalization based on user's practice history

4. **Analytics Integration:**
   - Track progression as a key user journey milestone
   - Include method ID, stages (from/to), and time spent in previous stage
   - Consider adding derived metrics for progression rates by method

This implementation completes the core progression flow from Epic 9, creating a full cycle of defining criteria (9.1), assessing readiness (9.2), and executing progression (9.3). 