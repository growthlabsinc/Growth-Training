# Story 7.3: Timer Alerts for Breaks/Overexertion

**Status:** Review

## Goal & Context

**User Story:** As a User, I want the timer to alert me for scheduled breaks or if I exceed a recommended maximum duration for a method, to promote safe practice.

**Context:** This story builds upon the previously implemented method-specific timer functionality (Story 7.2) by adding targeted alerts that enhance user safety and promote proper exercise practice. The interval timers already implemented in Story 7.2 will be leveraged for scheduled breaks, while new overexertion warnings will be added to notify users when they exceed the maximum recommended duration for a specific method.

## Detailed Requirements

- Utilize the interval timer (Story 7.2) for scheduled breaks.
- For methods with a maximum recommended duration (to be added to `growthMethods` data model as `maxRecommendedDurationSeconds`), if the timer (stopwatch mode) exceeds this, provide a distinct "Overexertion Warning" alert (visual and optional sound/vibration).
- User should be able to dismiss the alert and continue if they choose, but the warning should be clear.

## Acceptance Criteria (ACs)

- AC1: Scheduled break alerts are provided via the interval timer.
- AC2: Overexertion warning alert triggers if `maxRecommendedDurationSeconds` is exceeded in stopwatch mode.
- AC3: Overexertion alert is distinct and provides a clear warning.
- AC4: User can dismiss the overexertion alert.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards and understand the project structure. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Modify:
    - `Growth/Core/Models/GrowthMethod.swift` (TimerConfiguration already has maxRecommendedDurationSeconds)
    - `Growth/Features/Timer/Services/TimerService.swift` (Update to check for overexertion)
    - `Growth/Features/Timer/ViewModels/TimerViewModel.swift` (Expose overexertion state)
    - `Growth/Features/Timer/Views/TimerView.swift` (Add overexertion alert UI)
    - `Growth/Features/Timer/Views/Components/IntervalDisplayView.swift` (Enhance for better break visualization)

- **Key Technologies:**
  - SwiftUI for the alert UI
  - Combine for reactive state management
  - AVFoundation for alert sounds
  - UIKit's haptic feedback API for vibration alerts

- **UI/UX Notes:** 
  - The overexertion alert should be visually distinct from regular interval transitions
  - Use red color to indicate warning state
  - Alert should be dismissible but remain visible until acknowledged
  - Audio cues should be different for breaks vs. overexertion warnings

- **Data Structures:**
  - `TimerConfiguration` in `GrowthMethod.swift` already has `maxRecommendedDurationSeconds`
  - TimerService needs to track and expose an overexertion state

## Tasks / Subtasks

- [ ] Update TimerService to track overexertion state
  - [ ] Add overexertion detection in the tick() method
  - [ ] Add distinct sound for overexertion alert
  - [ ] Add methods to acknowledge/dismiss the overexertion alert

- [ ] Update TimerViewModel to expose overexertion state
  - [ ] Add @Published property for isExceedingMaxDuration
  - [ ] Add method to dismiss overexertion warning
  - [ ] Ensure overexertion state is properly tracked during backgrounding

- [ ] Update TimerView with overexertion alert UI
  - [ ] Create a distinct visual alert for overexertion
  - [ ] Ensure alert is dismissible by the user
  - [ ] Implement appropriate color changes for warning state

- [ ] Enhance break visualization in IntervalDisplayView
  - [ ] Make break intervals visually distinct

- [ ] Add distinct sound for overexertion alerts
  - [ ] Create/obtain a distinct sound file for warnings
  - [ ] Implement sound playing with proper volume controls

- [ ] Test all alert scenarios
  - [ ] Test interval-based break alerts
  - [ ] Test overexertion warning appearance and dismissal
  - [ ] Verify haptic feedback works as expected

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

- **Unit Tests:** 
  - Test overexertion detection logic in TimerService
  - Test alert dismissal logic
  - Test that overexertion state correctly triggers when maxRecommendedDurationSeconds is exceeded
  - Test that overexertion alert doesn't trigger for methods without a maxRecommendedDurationSeconds

- **Manual Verification:** 
  - Verify the visual distinction between interval transitions and overexertion alerts
  - Verify sound and haptic feedback works for different alert types
  - Verify that dismissing the alert works but allows the timer to continue
  - Verify state preservation when app is backgrounded during an overexertion alert 