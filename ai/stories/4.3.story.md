# Story 4.3: Session Detail View

**Status:** Complete

## Goal & Context

**User Story:** As a User, I want to view all the details of a specific past logged session, so I can recall my experience and notes for that session.

**Context:** This story follows the implementation of the Session History List (Story 4.2). After a user taps on a session in the history list, this view will display all recorded information for that specific session, allowing for a detailed review and providing options for management (like deletion).

## Detailed Requirements

- Design and implement a "Session Detail" screen.
- Screen should display all data for a selected session log from Firestore:
  - Date & Time.
  - Method Name (requires fetching the `GrowthMethod` object based on `methodId` from the `SessionLog`).
  - Duration.
  - Full User Notes.
  - Mood Check-in details (MoodBefore, MoodAfter).
- Provide options to Edit or Delete the log entry (Edit may be post-MVP, Delete is important for privacy). A confirmation dialog should be shown before deletion.
- UI must adhere to `docs/style-guide.md`, `docs/ui-ux-spec.md`, and Figma.

## Acceptance Criteria (ACs)

- AC1: All details of a selected session log are displayed accurately, including the method's title.
- AC2: User can navigate back to the Session History list.
- AC3: A "Delete" option is present and functional (with confirmation dialog). Upon deletion, the view should dismiss, and the session history list should reflect the change.
- AC4: (Post-MVP) An "Edit" option is present (can navigate to Log Session screen pre-filled).

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**
  - Files to Create:
    - `Growth/Features/SessionLogging/Views/SessionDetailView.swift`
  - Files to Modify:
    - `Growth/Features/SessionLogging/Views/SessionHistoryView.swift` (for navigation to this detail view)
    - `Growth/Core/Services/FirestoreService.swift` (to add `deleteSessionLog(logId: String, userId: String)` function)
    - `Growth/Features/SessionLogging/ViewModels/SessionViewModel.swift` (or similar, to handle deletion logic and state update. If no central ViewModel, logic might be in `SessionHistoryView` or `SessionDetailView`).
    - `Growth/Core/Models/SessionLog.swift` (if any changes are needed, though unlikely for this story).
    - `Growth/Core/Models/GrowthMethod.swift` (referenced for displaying method title).

- **Key Technologies:**
  - SwiftUI for UI
  - Firebase Firestore for data retrieval and deletion
  - Combine for reactive updates if a ViewModel is used

- **API Interactions / SDK Usage:**
  - Firestore:
    - Fetch `GrowthMethod` details using `methodId` from the `SessionLog` object.
    - Implement `deleteDocument` for the `sessionLogs` collection.
  - SwiftUI:
    - Navigation from `SessionHistoryView`.
    - Displaying formatted data.
    - Presenting a confirmation alert for deletion.

- **UI/UX Notes:**
  - Display session details clearly, following the style guide for typography and spacing.
  - The "Delete" button should be clearly visible, possibly with a destructive style cue (e.g., red text or icon).
  - The confirmation alert for deletion should be explicit (e.g., "Are you sure you want to delete this session log? This action cannot be undone.").
  - Ensure a loading state if fetching method details takes time.
  - UI must be responsive and accessible.

- **Data Structures:**
  - `SessionLog` (from `Growth/Core/Models/SessionLog.swift`)
  - `GrowthMethod` (from `Growth/Core/Models/GrowthMethod.swift`)

- **Environment Variables:**
  - None specific to this story beyond existing Firebase setup.

- **Coding Standards Notes:**
  - Follow standards in `docs/coding-standards.md`.
  - Ensure proper error handling for Firestore operations (fetching method, deleting log).
  - Manage view state effectively (e.g., loading, presenting alerts).

## Tasks / Subtasks

- [ ] Design and implement `SessionDetailView.swift` UI.
  - [ ] Display all `SessionLog` fields (Date, Duration, Notes, Moods).
  - [ ] Fetch and display the corresponding `GrowthMethod` title.
  - [ ] Add a "Delete" button.
  - [ ] Implement navigation back to `SessionHistoryView`.
- [ ] Implement navigation from `SessionHistoryView` to `SessionDetailView`, passing the selected `SessionLog`.
- [ ] Add `deleteSessionLog` function to `FirestoreService.swift`.
- [ ] Implement deletion logic in the relevant ViewModel or View:
  - [ ] Call `FirestoreService.deleteSessionLog`.
  - [ ] Show a confirmation alert before deleting.
  - [ ] Handle successful deletion (e.g., dismiss `SessionDetailView`, refresh `SessionHistoryView`).
  - [ ] Handle deletion errors.
- [ ] (Post-MVP) Design and implement "Edit" functionality.
- [ ] Write unit/integration tests for deletion logic and data display.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:**
  - Test `FirestoreService.deleteSessionLog` function.
  - Test ViewModel logic for deletion and alert presentation (if applicable).
- **Integration Tests:**
  - Test data fetching (SessionLog and GrowthMethod details) and display in `SessionDetailView`.
  - Test the delete functionality with Firestore, including confirmation.
- **Manual/CLI Verification:**
  - Navigate from session history to detail view.
  - Verify all session details are displayed correctly, including method name.
  - Test the delete button and confirmation dialog.
  - Confirm the session is removed from Firestore and the history list updates.
  - Verify UI adheres to `docs/style-guide.md`, `docs/ui-ux-spec.md`, and Figma.

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `Gemini 2.5 Pro`
- **Completion Notes:**
  - Created `Growth/Features/SessionLogging/Views/SessionDetailView.swift` to display details of a selected session log.
  - Implemented UI to show method title, date, time, duration, user notes, and mood before/after, styled with `AppTheme` and structured using a `List`.
  - Created `Growth/Features/SessionLogging/ViewModels/SessionDetailViewModel.swift` to manage data fetching (placeholder, as method is passed in), state (loading, error), and deletion logic.
  - Added a 'Delete' button to `SessionDetailView` with a confirmation alert.
  - Added `deleteSessionLog(logId: String, completion: @escaping (Error?) -> Void)` function to `Growth/Core/Services/FirestoreService.swift`.
  - Implemented logic in `SessionDetailViewModel` to call the Firestore service for deletion and to post a `.sessionLogDeleted` notification upon success.
  - `SessionDetailView` now dismisses itself upon receiving this notification for the current log.
  - `Growth/Features/SessionLogging/Views/SessionHistoryView.swift` was updated to listen for `.sessionLogDeleted` notifications and refresh its data by calling `viewModel.loadData()`.
  - Ensured navigation from `SessionHistoryView` correctly passes `SessionLog` and `GrowthMethod` to `SessionDetailView`.
- **Change Log:**
  - Initial Draft
  - Implemented view, view model, service update, and history view refresh for complete session detail viewing and deletion functionality. 