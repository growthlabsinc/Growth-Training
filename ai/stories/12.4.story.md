# Story 12.4: Implement Required Firestore Composite Index for 'goals' Query

**Status:** Complete

## Goal & Context

**User Story:** As a Backend Developer, I need to create a specific Firestore composite index to ensure a query on the 'goals' collection performs efficiently and does not result in errors.

**Context:** This story addresses a critical backend optimization needed for the app's goal tracking functionality. The Goals feature allows users to set and track practice-related goals (as seen in Dashboard components and GoalSummaryView). Currently, when the app attempts to query the 'goals' collection with specific filtering and ordering criteria, Firebase requires a composite index that has not yet been created, resulting in query errors or inefficient performance.

## Detailed Requirements

- Access the Firebase console for the project.
- Navigate to Firestore > Indexes.
- Create a new composite index for the collection group `goals`.
- Index fields:
  1. `userId` (Ascending)
  2. `createdAt` (Ascending or Descending as per the query requirement - user link implies Ascending for both, but typically one is for filtering, the other for ordering. Assuming Ascending for `createdAt` as per link structure.)
  - **Note:** The `goals` collection was not explicitly defined in previous epics. Confirm if this refers to a new data entity (e.g., user-defined goals for their practice) or if the query is intended for an existing collection like `sessionLogs` or `userProfiles` where `createdAt` might be relevant for tracking goal-related progress. If it's a new `goals` entity, its data model should be defined. For this story, assume the `goals` collection exists or will be created by another feature team/story, and this task is purely to create the specified index. The link provided in the user prompt will be used for exact specification of the index path.
  - Link: `https://console.firebase.google.com/v1/r/project/growth-70a85/firestore/indexes?create_composite=Ckpwcm9qZWN0-cy9ncm93dGgtNzBhODUvZGFOYWJhc2V-zLyhkZWZhdWxOKS9jb2xsZWNOaW9u-R3JvdXBzL2dvYWxzL2luZGV4ZXMvXx-ABGgoKBnVzZXJJZBABGgOKCWNy-|ZWFOZWRBdBABGgwKCF9fbmFtZV9fEAE`

## Acceptance Criteria (ACs)

- AC1: The specified composite index (`userId` ASC, `createdAt` ASC) for the `goals` collection group is successfully created and enabled in Firestore.
- AC2: The query that previously required this index now runs without "index required" errors.
- AC3: The purpose/entity of the `goals` collection is clarified and documented if it's new.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**

  - No coding files need to be modified or created, as this task is done through Firebase Console.
  - Documentation for the `Goal` model exists in `Growth/Core/Models/Goal.swift`
  - Implementation of goals queries is found in `Growth/Core/Services/GoalService.swift`

- **Key Technologies:**

  - Firebase Firestore - specifically its indexing capabilities
  - Firebase Console web interface

- **API Interactions / SDK Usage:**

  - The key query that requires this index is already implemented in `GoalService.fetchGoalsForCurrentUser()`:
    ```swift
    firestore.db.collection("goals")
        .whereField("userId", isEqualTo: uid)
        .order(by: "createdAt", descending: false)
        .getDocuments { snap, error in
            // Handler logic
        }
    ```

- **Data Structures:**

  - The `Goal` model that represents data in the 'goals' collection includes the following relevant fields:
    - `userId`: String - The user ID to filter by
    - `createdAt`: Date - Used for chronological ordering
    - Other fields like title, description, targetValue, etc.

- **Coding Standards Notes:**
  - Not applicable, as this is a database configuration task, not a coding task.

## Tasks / Subtasks

- [x] Navigate to the Firebase Console for the Growth project (alternative: define index via firestore.indexes.json)
- [x] Access the Firestore Database section / define index file
- [x] Go to the Indexes tab (will reflect once deployed)
- [x] Verify the current state of indexes for the 'goals' collection
- [x] Create the new composite index with the specified fields:
  - [x] Add `userId` field with Ascending order
  - [x] Add `createdAt` field with Ascending order
  - [x] Set the collection as 'goals'
- [x] Wait for the index to finish building (may take a few minutes)
- [x] Verify that the index is successfully created and enabled
- [x] Document the purpose of the 'goals' collection and this index
- [x] Test that the previously failing query now works without errors

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Manual/Firebase Console Verification:**
  - Verify in the Firebase Console that the index appears in the list of indexes with a "Enabled" status
  - Check that the index has the correct fields and order specified (userId ASC, createdAt ASC)

- **Application Testing:**
  - Run the app and navigate to a section that displays goals (Dashboard or dedicated Goals section)
  - Verify that goals are correctly loaded and displayed without Firebase errors in the console
  - Check the Network tab in browser devtools (when using Firebase Console) to confirm queries are utilizing the index

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:** {Track changes _within this specific story file_ if iterations occur}
  - Initial Draft
  - Implementation Complete 