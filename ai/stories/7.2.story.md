# Story 7.2: Method-Specific Timer Configuration (Countdown & Intervals)

**Status:** In Progress

## Goal & Context

**User Story:** As a User, when I start a timer for a specific Growth Method, I want it to be pre-configured for that method's recommended duration or interval structure.

**Context:**
This story extends the timer functionality implemented in Story 7.1 to support method-specific configurations. It will allow the timer to be pre-configured based on the properties of a specific Growth Method. This requires extending the data model and enhancing the timer service to support countdown and interval-based timers.

The timer will now be able to operate in different modes:
1. **Stopwatch Mode** (counting up from zero) - the default mode from Story 7.1
2. **Countdown Mode** (counting down from a specified duration)
3. **Interval Mode** (a series of timed intervals, each with its own name and duration)

## Requirements

1. **Extend the GrowthMethod Data Model**
   - Add the following fields to the `GrowthMethod` model in Firestore:
     - `timerConfig` (Map):
       - `recommendedDurationSeconds` (Number): The recommended exercise duration in seconds
       - `isCountdown` (Boolean): Whether to count down (true) or up/stopwatch (false)
       - `hasIntervals` (Boolean): Whether this method has interval-based timing
       - `intervals` (Array of Maps): List of interval configurations
         - For each interval: `{ name: String, durationSeconds: Number }`
       - `maxRecommendedDurationSeconds` (Number, Optional): Maximum recommended duration for safety

2. **Update the Swift GrowthMethod Model**
   - Create new structs for timer configuration
   - Update the `GrowthMethod` struct to include these new fields
   - Ensure proper Codable conformance for Firestore serialization/deserialization

3. **Enhance TimerService**
   - Add support for countdown mode
     - Track target duration and remaining time
     - Count down instead of up when in countdown mode
   - Add support for interval-based timing
     - Track current interval index, name, and duration
     - Handle transitions between intervals
     - Provide way to get current interval information
   - Add completion callbacks for countdown and intervals
   - Add configurable alerts (sound/vibration) for interval transitions and timer completion

4. **Update TimerViewModel**
   - Add method for configuring the timer based on a GrowthMethod
   - Add properties to expose interval information (current interval name, progress, etc.)
   - Add logic to play alerts at appropriate times
   - Handle forwarding completion callbacks to the UI

5. **Enhance Timer UI**
   - Update the TimerView to display:
     - Current interval name and duration (if applicable)
     - Progress through the current interval (optional progress bar)
     - Visual indication when transitioning between intervals
   - Add controls for audio feedback (mute/unmute)

6. **Method Detail Integration**
   - Add a button to launch the timer with the method's configuration from the Method Detail screen
   - Pass the GrowthMethod object to the TimerView when launched from a Method Detail screen

## Acceptance Criteria

- **AC1:** Timer correctly loads configuration from the selected Growth Method data.
- **AC2:** Countdown timer accurately counts down from the specified duration.
- **AC3:** Interval timer guides the user through each phase, displaying the current interval name and remaining time.
- **AC4:** Audio and/or haptic feedback (if enabled) triggers when intervals end or the total duration is met.
- **AC5:** If no specific configuration exists, timer defaults to stopwatch mode.
- **AC6:** Timer maintains its accuracy during app backgrounding and restoration.
- **AC7:** UI clearly communicates the current timer mode, interval (if applicable), and progress.

## Technical Implementation Context

### Files to Create/Modify

1. **Models:**
   - Update `Growth/Features/GrowthMethods/Models/GrowthMethod.swift` (or create if doesn't exist):
     - Add `TimerConfiguration`, `Interval`, and related structs

2. **Services:**
   - Enhance `Growth/Features/Timer/Services/TimerService.swift`:
     - Add countdown and interval functionality
     - Add completion handlers and alert triggers

3. **ViewModels:**
   - Enhance `Growth/Features/Timer/ViewModels/TimerViewModel.swift`:
     - Add method-specific configuration handling
     - Add interval state management

4. **Views:**
   - Update `Growth/Features/Timer/Views/TimerView.swift`:
     - Add interval display components
     - Add audio feedback controls
   - Create `Growth/Features/Timer/Views/Components/IntervalDisplayView.swift`:
     - Component to show current interval name and progress

### Key Technologies & Implementation Notes

1. **Countdown Functionality:**
   - Modify the timer logic to count down instead of up when in countdown mode
   - When duration is reached, trigger completion handling
   - Use same background mode support as stopwatch mode

2. **Interval Management:**
   - Track current interval index in the array
   - Calculate progress within each interval
   - Handle transitions between intervals (including sound/haptic feedback)
   - Proceed to next interval automatically when current interval completes

3. **Sound/Haptic Feedback:**
   - Use `AVAudioPlayer` for alert sounds
   - Use `UINotificationFeedbackGenerator` for haptic feedback
   - Ensure sounds can play during background mode
   - Make feedback configurable (on/off)

4. **Firestore Integration:**
   - Ensure proper handling of optional fields (not all methods will have timer configurations)
   - Use strong typing with Codable protocol for the GrowthMethod model
   - Handle migration for existing data that lacks these fields

## Tasks

1. **Update GrowthMethod Model**
   - Define the `TimerConfiguration` and `Interval` model structs
   - Update the `GrowthMethod` struct to include timer configuration fields
   - Ensure proper Codable implementation for Firestore

2. **Enhance TimerService**
   - Add properties for countdown and interval modes
   - Modify timer logic to support countdown
   - Add interval tracking logic
   - Add completion/transition callbacks
   - Add sound/haptic feedback functionality

3. **Enhance TimerViewModel**
   - Add method to configure timer based on GrowthMethod
   - Add properties to expose interval information
   - Add sound/haptic feedback control
   - Update time formatting to handle countdown vs. stopwatch display

4. **Enhance Timer UI**
   - Update TimerView to support interval display
   - Create IntervalDisplayView component
   - Add progress indicators for intervals
   - Add mute/unmute toggle for sound feedback

5. **Method Detail Integration**
   - Update MethodDetailView (if it exists) to include a "Start Timer" button
   - Add navigation from Method Detail to Timer with configuration passing

6. **Implement Tests**
   - Unit tests for countdown and interval functionality
   - Integration tests for method configuration loading
   - Verify background mode functionality for all timer modes

## Testing Requirements

### Unit Tests
- Test countdown timer functionality with various durations
- Test interval transitions and completion handling
- Test sound/haptic feedback triggers
- Test timer configuration from GrowthMethod objects

### Integration Tests
- Test loading timer configurations from GrowthMethod objects
- Test full interval sequences with multiple intervals
- Test navigation from Method Detail to pre-configured Timer

### Manual Tests
- Verify countdown timer accuracy
- Verify interval display and transitions
- Test sound/haptic feedback
- Verify background mode for all timer types
- Test with various configurations (long/short intervals, many/few intervals)

## Dependencies
- Completion of Story 7.1: Basic Timer UI & Functionality
- GrowthMethod model and Firestore integration

## Notes
- Audio feedback should respect the device's mute setting, but provide a visual alternative
- Consider using progressive disclosure for interval details (e.g., show detail on tap)
- The data model changes require updates to Firestore, ensure admin tools/scripts are created to migrate existing data
- Consider saving timer progress in UserDefaults to restore even complex interval timers after backgrounding/termination 